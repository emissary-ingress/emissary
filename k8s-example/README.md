# Example files:

* `01-*.yaml` - Set up the namespace and other very-early tasks
  - `01-namespace.yaml` - Set up the namespace
* `02-*.yaml` - Things that must happen *before* Ambassador starts
  - `02-ambassador-certs.yaml` - TLS certificate for Ambassador
    (generated by Makefile)
* `03-*.yaml` - Ambassador
  - `03-ambassador.yaml` - Load-balancer deployment and service.
  - `03-ambassador-pro-standalone.yaml` - Authorization deployment and
    service.
* `04-*.yaml` - Example applications
  - `04-httpbin.yaml` - Service example that will seat behind the load
    balancer.
  - `04-httpbin-policy.yaml` - Tells which resources the
    Ambassador-Pro service should protect.
  - `04-tenants.yaml` - Tells which applications should Ambassador-Pro
    protects.

# Setup and deployment:

## Configuration:

1. In `03-ambassador-pro-standalone.yaml`, search for
   `AUTH_PROVIDER_URL`. This is the absolute URL that allows
   Ambassador-Pro communicating with the auth provider. In this case,
   Auth0.com.
2. In `04-tenants.yaml`, at least on app configuration needs to be
   supplied to `tenants` list. Follow the instructions in the manifest
   on how to configure an application.

## Deployment:

 1. Create a k8s cluster.

 2. Make sure that you have cluster-admin permissions:

        $ kubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user user@datawire.io

 3. Deploy Ambassador

        $ kubectl apply -f k8s-standalone/01-*.yaml
        $ kubectl apply -f k8s-standalone/02-*.yaml
        $ kubectl apply -f k8s-standalone/03-ambassador.yaml

 4. Get Ambassador's external address

 5. Edit `k8s-standalone/03-ambassador-pro-standalone.yaml` by
    changing `AUTH_CALLBACK_URL` to point to the external address.

        e.g. http://{EXTERNAL IP}/callback

 6. Create an Auth0 application and set your callback to
    `http://{EXTERNAL IP}/callback`. In the app `Connections`, make
    sure that `google-oauth2` is enabled.

 7. Edit `k8s-standalone/03-ambassador-pro-standalone.yaml` by
    changing `AUTH_DOMAIN` to your Auth0 app domain.

        e.g.  {USERNAME}.auth0.com

 8. Edit `k8s-standalone/03-ambassador-pro-standalone.yaml` by
     changing `AUTH_AUDIENCE` to your Auth0 app audience.

        e.g.  https://{USERNAME}.auth0.com/api/v2/

 9. Edit `k8s-standalone/03-ambassador-pro-standalone.yaml` by
    changing `AUTH_CLIENT_ID` to your Auth0 app client-id.

 10. Run these commands:

        $ kubectl apply -f k8s-standalone/03-ambassador-pro-standalone.yaml
        $ kubectl apply -f k8s-standalone/04-httpbin.yaml
        $ kubectl apply -f k8s-standalone/04-httpbin-policy.yaml
        $ kubectl apply -f k8s-standalone/04-tenants.yaml

 11. By running `$ kubectl get services -n standalone`, you should see
     something like these:

        ambassador         LoadBalancer   10.31.248.239   35.230.19.92   80:30664/TCP     16m
        ambassador-admin   NodePort       10.31.240.190   <none>         8877:30532/TCP   16m
        ambassador-pro     ClusterIP      10.31.254.65    <none>         80/TCP           12m
        httpbin            NodePort       10.31.245.125   <none>         80:30641/TCP     13m

## Verifying Ambassador-Pro deployment:

The logs should show something like this:

    time="2018-12-27 22:01:13" level=info msg="loading tenant domain={ APP DOMAIN }, client_id={ APP CLIENT ID }" MAIN=controller
    time="2018-12-27 22:02:24" level=info msg="loading rule host=*, path=/httpbin/ip, public=true, scope=offline_access email" MAIN=controller
    time="2018-12-27 22:02:24" level=info msg="loading rule host=*, path=/httpbin/user-agent, public=false, scope=offline_access brogramemrs" MAIN=controller
    time="2018-12-27 22:02:24" level=info msg="loading rule host=*, path=/qotm, public=true, scope=offline_access dogs" MAIN=controller

This error means that no app has been supplied in the list of tenants:

    time="2018-12-27 23:22:05" level=error msg="0 tenant apps configured" MAIN=controller

# Test plan:

## Testing Single Application:

1. From a browser call the following: `{ TENANT URL }/httpbin/ip`

   Client should not get redirected to Auth0 and an IP should be
   displayed.

2. From a browser call the following: `{ TENANT URL }/httpbin/headers`

   Client should get redirected to Auth0 after a successful login, the
   HTTP request headers should be displayed.

3. Go to `{ TENANT URL }/httpbin/user-agent`.

   This should display your `user-agent` without asking for
   authorization or sending you to Auth0.

4. Open you browser's admin tool and delete your `access_token` cookie.

5. Go to `{ TENANT URL }/httpbin/user-agent`.

   You should once again be redirected to Auth0.

## Testing Multiple Applications:

1. Configure a second app domain in Auth0 and add it to the `tenants`
   list (in `04-tenants.yaml`).

2. From a browser: `{ TENANT URL 2 }/httpbin/ip`

   Client should not get redirected to Auth0 and an IP should be
   displayed.

3. From a browser: `{ TENANT URL 2 }/httpbin/user-agent`

   Client should get redirected to Auth0 after a successful login, the
   user-agent information should be displayed.

4. Open a new tab: `{ TENANT URL 1 }/httpbin/user-agent`

   If it's the first time calling this URL, the client should be
   redirected to Auth0. Note that URL 1 and URL 2 will have their own
   access_token cookies and access should be grant independently from
   each other.
