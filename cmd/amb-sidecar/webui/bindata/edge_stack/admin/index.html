<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <title>
      Ambassador Edge Stack Admin
    </title>
    
    <!--Admin style definitions-->
    <style>

      body {
	  font-family: Source Sans Pro,sans-serif;
	  margin-left: 2em;
	  margin-right: 2em;
      }
      #all-wrapper {
	  width: 80%;
	  margin-left: 10%;
      }
      #ambassador-logo {
	  background-color: black;
	  padding: 5px;
	  width: 456px;
	  height: 42px;
          margin: auto;
	  margin-bottom: 1em;
      }
      div.info-blob {
	  border: 1px solid #ede7f3;
	  box-shadow: 0 2px 4px rgba(0,0,0,.1);
	  padding: 0.5em;
	  margin-bottom: 0.6em;
	  line-height: 1.3;
      }
      div.info-blob2 {
	  border: thin solid grey;
	  border-radius: 0.4em;
	  padding: 0.5em;
	  margin-bottom: 0.6em;
	  line-height: 1.3;
      }
      div.info-title {
	  font-weight: bold;
	  font-size: 120%;
      }
      span.command {
	  background-color: #f5f2f0;;
	  padding: 3px;
	  letter-spacing: .2px;
	  font-family: Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;
	  font-size: 90%;
	  word-spacing: normal;
	  word-break: normal;
	  word-wrap: normal;
	  hypens: none;
      }
      div.overage-alert {
	  border: 3px solid red;
	  border-radius: 0.7em;
	  padding: 0.5em;
	  background-color: #FFe8e8;
      }
      
    </style>


    <style>

      div.host, div.mapping {
          padding: 1em 1em;
      }

      span.json {
          unicode-bidi: embed;
          font-family: monospace;
      }

      details {
          margin-left: 1em;
      }
      
    </style>
    <script type="module" src="tabs.js"></script>
    <script type="module" src="signup.js"></script>
  </head>
  <body>
    <div id="all-wrapper">
      <div id="ambassador-logo">
	<a href="https://www.getambassador.io/">
	  <img src="https://www.getambassador.io/images/ambassador-logo-white.svg" alt="Ambassador Edge Stack" /> 
	</a>
      </div>

      <div style="display:none" id="main">
        <dw-tabs>
          <div class="info-blob" slot="sticky">
            <dw-signup></dw-signup>
          </div>

          <dw-tab name="Hosts">
            <h2>Hosts</h2>
            <a href="../tls/" class="auth">add</a>
            <div class="info-blob">
              <div id="hosts"></div>
            </div>
          </dw-tab>

          <dw-tab name="Mappings">    
            <h2>Mappings </h2>
            <a id="add-mapping" style="cursor:pointer;color:blue;text-decoration:underline;">add</a>
            <div id="add-mapping-form" style="display:none">
              Name: <input id="add-mapping-name" type="text" name="prefix"/>
              Prefix: <input id="add-mapping-prefix" type="text" name="prefix"/>
              Rewrite: <input id="add-mapping-rewrite" type="text" name="rewrite" value=""/>
              Target: <input id="add-mapping-target" type="text" name="target"/>
              <button id="add-mapping-button">Add</button>
            </div>
            <div class="info-blob">
              <div id="mappings"></div>
            </div>
          </dw-tab>

          <dw-tab name="APIs">
            <h2>APIs</h2>
            <a href="/docs/">OpenAPI Documentation</a>
          </dw-tab>

          <dw-tab name="Documentation">
            <ul>
              <li><a href="https://getambassador.io/docs/">Ambassador Documentation</a></li>
              <li><a href="https://getambassador.io/concepts/overview">Concepts</a></li>
              <li><a href="https://getambassador.io/docs/guides/">Guides</a></li>
              <li><a href="https://getambassador.io/reference/configuration">Configuration Reference</a></li>
            </ul>
          </dw-tab>
        </dw-tabs>
      </div>

    </div>
  </body>

  <!-- Scripts -->
  <script type="text/javascript">
    $.ajaxSetup({
      beforeSend: (xhr, settings) => {
	xhr.setRequestHeader("Authorization", "Bearer " + window.location.hash.slice(1));
      }
    });

    var snapshot

    function path(el) {
      if (el.parentElement == null) {
        return ""
      } else {
        return path(el.parentElement) + "_" + el.id
      }
    }

    function renderKind(obj) {
      let md = obj.metadata
      return $(`<div class="${obj.kind.toLowerCase()}" id="${md.namespace}_${md.name}"></div>`)
        .append(renderMetadata(md))
        .append(renderSpec(obj.spec))
        .append(renderStatus(obj.status))
    }

    function renderMetadata(md) {
      return $(`<div class="metadata" id="metadata"></div>`)
        .append(`<span class="name">${md.namespace}/${md.name}</span>`)
        .append($(`<details class="labels" id="labels"><summary>labels</summary></details>`)
                .append(renderObj(md.labels)))
    }

    function renderObj(obj, cls="obj") {
      let result = $(`<div class="${cls}"></div>`)
      $.each(obj, (name, value) => {
        details = $(`<details class="field" id="${name}"><summary>${name}</summary></details>`)
        result.append(details)
        scalars = ["string", "number", "boolean"]
        if (scalars.includes(typeof value)) {
          details.append(`<span class="value">${value}</span>`)
        } else {
          details.append(renderObj(value))
        }
      })
      return result
    }

    function renderSpec(spec) {
      return renderObj(spec, "spec")
    }

    function renderStatus(status) {
      if (typeof status == "undefined") {
        return $(`<details class="status" id="status"><summary>Status: none</summary></details>`)
      }
      return $(`<details class="status" id="status"><summary>Status: ${status.state}</summary></details>`).
        append(renderObj(status))
    }

    function render() {
      $.getJSON("/edge_stack/api/snapshot", data=>{
        $(".auth").each((i, e) => {
          href = e.getAttribute("href")
          if (!href.includes("#")) {
            e.setAttribute("href", href+window.location.hash)
          }
        })

        snapshot = data
        let kube = "Kubernetes" in data ? data.Kubernetes : {
          "Host": [],
          "Mapping": []
        }

        let opened = new Set()
        $("details[open]").each((i, e)=>opened.add(path(e)))

        let hosts = kube.Host || []
        let hostsDiv = $("#hosts").empty()

        $.each(hosts, (index, host) => {
          hostsDiv.append(renderKind(host))
        })
        if (hosts.length == 0) {
          hostsDiv.append(`<p>there are no hosts, click <a href="../tls/${window.location.hash}">here</a> to create some</p>`)
        }

        let mappings = kube.Mapping || []
        let mappingsDiv = $("#mappings").empty()
        $.each(mappings, (index, mapping) => {
          mappingsDiv.append(renderKind(mapping))
        })
        if (mappings.length == 0) {
          mappingsDiv.append(`<p>there are no mappings, click <a href="todo">here</a> to create some</p>`)
        }

        $("details").each((i, e)=>{
          if (opened.has(path(e))) {
            e.setAttribute("open", "")
          }
        })

        // We default the main section of the page to invisible until
        // we get at least one successful interaction with the server
        // so that we don't flash an empty set of hosts and mappings
        // before redirect to login.
        $("#main").show()

        setTimeout(render, 1000)
      }).fail(xhr=>{
        if (xhr.status == 401 || xhr.status == 403) {
          window.location.replace("../login/")
        } else {
          console.log(xhr)
        }
      })
    }

    $(render)

    $(()=>{
      $("#add-mapping").click((e)=>{
        e.target.style.display="none";
        $("#add-mapping-form").show()
      })

      $("#add-mapping-button").click((e)=>{
        let yaml = `
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: "${$("#add-mapping-name").val()}"
  namespace: default
spec:
  prefix: "${$("#add-mapping-prefix").val()}"
  rewrite: "${$("#add-mapping-rewrite").val()}"
  service: "${$("#add-mapping-target").val()}"
`
        $.post("/edge_stack/api/apply", yaml, null, "text").fail(xhr=>{
          alert("BAD\n\n" + yaml + "\n\n" + xhr.responseText)
        }).done(resp=>{
          alert("OK\n" + resp)
        })

        $("#add-mapping-form").hide()
        $("#add-mapping").show()
      })
    })
    </script>
</html>
