<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://codejoust.github.io/session.js/session-0.4.js"></script>
    <title>
      Ambassador Edge Stack Admin
    </title>

    <!--Admin style definitions-->
    <style>
      body {
        font-family: Source Sans Pro, sans-serif;
        margin-left: 2em;
        margin-right: 2em;
      }

      #all-wrapper {
        width: 80%;
        margin-left: 10%;
      }

      #ambassador-logo {
        background-color: white;
        padding: 5px;
        width: 456px;
        height: 42px;
        margin-bottom: 1em
      }

      div.info-blob {
        border: 1px solid #ede7f3;
        box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        padding: 0.5em;
        margin-bottom: 0.6em;
        line-height: 1.3;
      }

      div.info-blob2 {
        border: thin solid grey;
        border-radius: 0.4em;
        padding: 0.5em;
        margin-bottom: 0.6em;
        line-height: 1.3;
      }

      div.info-title {
        font-weight: bold;
        font-size: 120%;
      }

      span.command {
        background-color: #f5f2f0;
        padding: 3px;
        letter-spacing: .2px;
        font-family: Consolas, Monaco, Andale Mono, Ubuntu Mono, monospace;
        font-size: 90%;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        hyphens: none;
      }

      div.overage-alert {
        border: 3px solid red;
        border-radius: 0.7em;
        padding: 0.5em;
        background-color: #FFe8e8;
      }

      div.host, div.mapping {
          padding: 1em 1em;
      }

      span.json {
        unicode-bidi: embed;
        font-family: monospace;
      }

      details {
        margin-left: 1em;
      }

      h2 {
          margin: 0.1em;
      }

      login-gate {
          margin: 0;
          padding: 0;
      }
    </style>
  </head>

  <body>
    <div id="all-wrapper">
      <div id="ambassador-logo">
        <a href="https://www.getambassador.io/">
          <img src="https://www.getambassador.io/images/ambassador-logo-black.svg" alt="Ambassador Edge Stack" />
        </a>
      </div>

      <div id="main">
        <login-gate>
          <aes-snapshot-provider>
            <dw-tabs>
              <div class="info-blob" slot="sticky">
                <dw-signup></dw-signup>
              </div>

              <dw-tab name="Hosts">
                <div class="info-blob">
                  <h2>Hosts</h2>

                  <p>A Host represents a domain that is managed by Ambassador, e.g., example.org.</p>

                  <dw-host-add><span style="cursor:pointer;color:blue;">Add a Host</span></dw-host-add>
                </div>

                <div class="info-blob">
                  <div id="hosts"></div>
                </div>
              </dw-tab>

              <dw-tab name="Mappings">
                <div class="info-blob">
                  <h2>Mappings</h2>

                  <p>
                    A Mapping is an association between a URL (called a prefix) and a target
                    service (called a target).
                  </p>

                  <a id="add-mapping" style="cursor:pointer;color:blue;text-decoration:underline;">Add a Mapping</a>
                </div>

                <div id="add-mapping-form" style="display:none">
                  Name: <input id="add-mapping-name" type="text" name="prefix"/>
                  Prefix: <input id="add-mapping-prefix" type="text" name="prefix"/>
                  Rewrite: <input id="add-mapping-rewrite" type="text" name="rewrite" value=""/>
                  Target: <input id="add-mapping-target" type="text" name="target"/>
                  <button id="add-mapping-button">Add</button>
                </div>
                <div class="info-blob">
                  <div id="mappings"></div>
                </div>
              </dw-tab>

              <dw-tab name="APIs">
                <div class="info-blob">
                  <dw-apis id="apis"></dw-apis>
                </div>
              </dw-tab>

              <dw-tab name="Documentation">
                <div class="info-blob">
                  <ul>
                    <li><a href="https://getambassador.io/docs/">Ambassador Documentation</a></li>
                    <li><a href="https://getambassador.io/concepts/overview">Concepts</a></li>
                    <li><a href="https://getambassador.io/docs/guides/">Guides</a></li>
                    <li><a href="https://getambassador.io/reference/configuration">Configuration Reference</a></li>
                  </ul>
                </div>
              </dw-tab>
            </dw-tabs>
          </aes-snapshot-provider>
        </login-gate>
      </div>

    </div>
  </body>

  <!-- Scripts -->
  <script async defer type="module" src="https://cdn.pika.dev/-/lit-element/2.2.1/dist-es2019/lit-element.min.js"></script>
  <script async defer type="module" src="/edge_stack/components/context.js"></script>
  <script async defer type="module" src="/edge_stack/components/login-gate.js"></script>
  <script async defer type="module" src="/edge_stack/components/tabs.js"></script>
  <script async defer type="module" src="/edge_stack/components/apis.js"></script>
  <script async defer type="module" src="/edge_stack/components/signup.js"></script>
  <script async defer type="module" src="/edge_stack/components/host.js"></script>
  <script async defer type="module" src="/edge_stack/components/snapshot.js"></script>
  <script async defer type="module" src="/edge_stack/components/aes-mappings.js"></script>

  <script type="module" src="https://unpkg.com/rapidoc/dist/rapidoc-min.js"></script>

  <script type="module">
    import {getCookie} from '/edge_stack/components/cookies.js';

    $.ajaxSetup({
      beforeSend: (xhr, settings) => {
        xhr.setRequestHeader("Authorization", "Bearer " + getCookie("edge_stack_auth"));
      }
    });

    var snapshot

    function path(el) {
      if (el.parentElement == null) {
        return ""
      } else {
        return path(el.parentElement) + "_" + el.id
      }
    }

    function renderKind(obj) {
      let md = obj.metadata
      return $(`<div class="${obj.kind.toLowerCase()}" id="${md.namespace}_${md.name}"></div>`)
        .append(renderMetadata(md))
        .append(renderSpec(obj.spec))
        .append(renderStatus(obj.status))
    }

    function renderMetadata(md) {
      return $(`<div class="metadata" id="metadata"></div>`)
        .append(`<span class="name">${md.namespace}/${md.name}</span>`)
        .append($(`<details class="labels" id="labels"><summary>labels</summary></details>`)
          .append(renderObj(md.labels)))
    }

    function renderObj(obj, cls="obj") {
      let result = $(`<div class="${cls}"></div>`)
      $.each(obj, (name, value) => {
        let details = $(`<details class="field" id="${name}"><summary>${name}</summary></details>`)
        result.append(details)
        let scalars = ["string", "number", "boolean"]
        if (scalars.includes(typeof value)) {
          details.append(`<span class="value">${value}</span>`)
        } else {
          details.append(renderObj(value))
        }
      })
      return result
    }

    function renderSpec(spec) {
      return renderObj(spec, "spec")
    }

    function renderStatus(status) {
      if (typeof status == "undefined") {
        return $(`<details class="status" id="status"><summary>Status: none</summary></details>`)
      }
      return $(`<details class="status" id="status"><summary>Status: ${status.state}</summary></details>`).
        append(renderObj(status))
    }

    function render() {
      $.getJSON("/edge_stack/api/snapshot", data => {
        snapshot = data
        let kube = "Kubernetes" in data ? data.Kubernetes : {
          "Host": [],
          "Mapping": []
        }

        let opened = new Set()
        $("details[open]").each((i, e) => opened.add(path(e)))

        let hosts = kube.Host || []
        let hostsDiv = $("#hosts").empty()

        $.each(hosts, (index, host) => {
          hostsDiv.append(renderKind(host))
        })
        if (hosts.length == 0) {
          hostsDiv.append(`<p>There are no hosts defined.`)
        }

        let mappings = kube.Mapping || []
        let mappingsDiv = $("#mappings").empty()
        $.each(mappings, (index, mapping) => {
          mappingsDiv.append(renderKind(mapping))
        })
        if (mappings.length == 0) {
          mappingsDiv.append(`<p>There are no mappings defined.`)
        }

        $("details").each((i, e) => {
          if (opened.has(path(e))) {
            e.setAttribute("open", "")
          }
        })

        setTimeout(render, 1000)
      }).fail(xhr => console.log('Failed XHR', xhr));
    }

    $(render)

    $(() => {
      $("#add-mapping").click((e) => {
        e.target.style.display = "none";
        $("#add-mapping-form").show()
      })

      $("#add-mapping-button").click((e) => {
        let yaml = `
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: "${$("#add-mapping-name").val()}"
  namespace: default
spec:
  prefix: "${$("#add-mapping-prefix").val()}"
  rewrite: "${$("#add-mapping-rewrite").val()}"
  service: "${$("#add-mapping-target").val()}"
`
        $.post("/edge_stack/api/apply", yaml, null, "text").fail(xhr => {
          alert("BAD\n\n" + yaml + "\n\n" + xhr.responseText)
        }).done(resp => {
          alert("OK\n" + resp)
        })

        $("#add-mapping-form").hide()
        $("#add-mapping").show()
      })
    })
  </script>
</html>
