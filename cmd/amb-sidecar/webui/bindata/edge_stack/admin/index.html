<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="utf-8">
    <title>Ambassador Edge Stack - Admin</title>
    <style>
      body {
	  max-width: 8in;
	  margin: auto;
      }
    </style>
  </head>
  <body>
    <div>
      <button id="signup">Click here to sign up for a community license.</button>
      <style>
        #signup {
            margin: auto;
            width: 50%;
        }

        #signup-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left:0;
            top:0;
            width:100%;
            height:100%;
            overflow:auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }

        #signup-content, #signup-finished {
            display: none;
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        #signup-error {
            color: #fe0000;
        }

        .invalid {
            background-color: #fe0000;
        }
      </style>
      <div id="signup-modal">
        <div id="signup-content">
          <form>
	    <span>Email:</span> <input id="signup-email" type="text" name="email" value=""/>
	    <span>Confirm:</span> <input id="signup-email-confirm" type="text" name="email-confirm" value=""/>
            <input id="signup-cancel" type="button" value="Cancel" /><input id="signup-go" type="button" value="Signup"/>
          </form>
          <div id="signup-error"/>
        </div>
        <div id="signup-finished">
          <span id="signup-finished-text"></span>
          <button id="signup-finished-continue">Continue</button>
        </div>
      </div>
      <script>
        var signup = document.getElementById("signup")
        var modal = document.getElementById("signup-modal")
        var email = document.getElementById("signup-email")
        var confirm = document.getElementById("signup-email-confirm")
        var cancel = document.getElementById("signup-cancel")
        var go = document.getElementById("signup-go")
        var error = document.getElementById("signup-error")
        var content = document.getElementById("signup-content")
        var finished = document.getElementById("signup-finished")
        var finished_text = document.getElementById("signup-finished-text")
        var cont = document.getElementById("signup-finished-continue")

        reset = function() {
          modal.style.display="none";
          content.style.display="none";
          email.value="";
          confirm.value="";
          finished.style.display="none"
          finished_text.innerHTML="";
          cont.style.display="none";
        }

        cancel.onclick = reset
        cont.onclick = reset

        signup.onclick = function() {
          modal.style.display="block";
          content.style.display="block";
          email.focus();
        }


        go.onclick = function() {
          if (email.value == "") {
            email.classList.add("invalid");
            error.innerHTML="please supply an email"
          } else if (email.value != confirm.value) {
            email.classList.remove("invalid");
            confirm.classList.add("invalid");
            error.innerHTML="emails do not match"
          } else {
            email.classList.remove("invalid");
            confirm.classList.remove("invalid");
            error.innerHTML="";

            content.style.display="none";
            finished.style.display="block";
            cont.style.display="none";
            finished_text.innerHTML="Posting..."

            fetch("https://metriton.datawire.io/signup", {
              method: "POST",
              headers:{
                "content-type": "application/json; charset=UTF-8"
              },
              body: JSON.stringify({
                email: email.value,
                confirm: confirm.value
              })
            })
              .then(data=>{return data.json()})
              .then(res=>{
                console.log(res);
                cont.style.display="block";
                if ("vid" in res) {
                  finished_text.innerHTML="Congratulations, please look for an email to " + email.value
                } else {
                  finished_text.innerHTML="Sorry, there was a problem processing your request. Please contact support@datawire.io and supply this:<br>" + btoa(JSON.stringify(res))
                }
              })
              .catch(error=>console.log(error))
          }
        }
      </script>
    </div>

    <style>
      div.host, div.mapping {
          padding: 1em 1em;
      }

      span.json {
          unicode-bidi: embed;
          font-family: monospace;
      }

      details {
          margin-left: 1em;
      }
    </style>

    <script type="text/javascript">
      var snapshot

      function path(el) {
        if (el.parentElement == null) {
          return ""
        } else {
          return path(el.parentElement) + "_" + el.id
        }
      }

      function renderKind(obj) {
        let md = obj.metadata
        return $(`<div class="${obj.kind.toLowerCase()}" id="${md.namespace}_${md.name}"/>`)
          .append(renderMetadata(md))
          .append(renderSpec(obj.spec))
          .append(renderStatus(obj.status))
      }

      function renderMetadata(md) {
        return $(`<div class="metadata" id="metadata"/>`)
          .append(`<span class="name">${md.namespace}/${md.name}</span>`)
          .append($(`<details class="labels" id="labels"><summary>labels</summary></details>`)
                  .append(renderObj(md.labels)))
      }

      function renderObj(obj, cls="obj") {
        let result = $(`<div class="${cls}"/>`)
        $.each(obj, (name, value) => {
          details = $(`<details class="field" id="${name}"><summary>${name}</summary></details>`)
          result.append(details)
          scalars = ["string", "number", "boolean"]
          if (scalars.includes(typeof value)) {
            details.append(`<span class="value">${value}</span>`)
          } else {
            details.append(renderObj(value))
          }
        })
        return result
      }

      function renderSpec(spec) {
        return renderObj(spec, "spec")
      }

      function renderStatus(status) {
        if (typeof status == "undefined") {
          return $(`<details class="status" id="status"><summary>Status: none</summary></details>`)
        }
        return $(`<details class="status" id="status"><summary>Status: ${status.state}</summary></details>`).
          append(renderObj(status))
      }

      function render() {
        $.getJSON("/edge_stack/api/snapshot", data=>{
          snapshot = data
          let kube = "Kubernetes" in data ? data.Kubernetes : {
            "Host": [],
            "Mapping": []
          }

          let opened = new Set()
          $("details[open]").each((i, e)=>opened.add(path(e)))

          let hosts = kube.Host
          let hostsDiv = $("#hosts").empty()

          $.each(hosts, (index, host) => {
            hostsDiv.append(renderKind(host))
          })
          if (hosts.length == 0) {
            hostsDiv.append(`<p>there are no hosts, click <a href="todo">here</a> to create some</p>`)
          }

          let mappings = kube.Mapping
          let mappingsDiv = $("#mappings").empty()
          $.each(mappings, (index, mapping) => {
            mappingsDiv.append(renderKind(mapping))
          })
          if (mappings.length == 0) {
            mappingsDiv.append(`<p>there are no mappings, click <a href="todo">here</a> to create some</p>`)
          }

          $("details").each((i, e)=>{
            if (opened.has(path(e))) {
              e.setAttribute("open", "")
            }
          })

          setTimeout(render, 1000)
        })
      }

      $(render)
    </script>

    <h2>Hosts</h2>
    <div id="hosts"></div>

    <h2>Mappings</h2>
    <div id="mappings"</div>

    </div>
  </body>
</html>
