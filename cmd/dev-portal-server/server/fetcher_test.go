package server

import (
	"errors"
	"fmt"
	"io/ioutil"
	"sort"
	"testing"

	. "github.com/datawire/apro/cmd/dev-portal-server/kubernetes"
	. "github.com/datawire/apro/cmd/dev-portal-server/openapi"
	. "github.com/onsi/gomega"
	log "github.com/sirupsen/logrus"
)

func TestDiffCalculator(t *testing.T) {
	g := NewGomegaWithT(t)
	A, B := Service{Name: "a"}, Service{Name: "b"}
	C, D := Service{Name: "c"}, Service{Name: "d"}

	// Starting point: we know about A and B
	calc := NewDiffCalculator([]Service{A, B})

	// Round 1: we detect A and C. That means B should be marked as deleted.
	calc.Add(A)
	calc.Add(C)
	g.Expect(calc.NewRound()).To(Equal([]Service{B}))

	// Round 2: we detect A and C. That means no deletes.
	calc.Add(A)
	calc.Add(C)
	g.Expect(calc.NewRound()).To(Equal([]Service{}))

	// Round 3: we detect A and C and D. That means no deletes.
	calc.Add(A)
	calc.Add(C)
	calc.Add(D)
	g.Expect(calc.NewRound()).To(Equal([]Service{}))

	// Round 4: we detect B and C. That means A and D are deleted.
	calc.Add(B)
	calc.Add(C)
	result := calc.NewRound()
	sort.Slice(result, func(i, j int) bool { return result[i].Name < result[j].Name })
	g.Expect(result).To(Equal([]Service{A, D}))

	// Round 5: we detect nothing. That means B and C are deleted.
	result = calc.NewRound()
	sort.Slice(result, func(i, j int) bool { return result[i].Name < result[j].Name })
	g.Expect(result).To(Equal([]Service{B, C}))
}

// Hard-code diagd output, as well as OpenAPI docs for one service:
func fakeHTTPGet(url string, internalSecret string, logger *log.Entry) ([]byte, error) {
	if url == "http://localhost:8877/ambassador/v0/diag/?json=true" {
		if internalSecret != "" {
			return nil, errors.New("Only .ambassador-internal URLs should get secret")
		}
		return []byte(`{"active_elements":["--internal--","devportal.default.1","httpbin.default.1","openapi.default.1","qotm.default.1"],"ambassador_elements":{"--diagnostics--":{"kind":"Diagnostics","location":"--diagnostics--"},"--internal--":{"kind":"Internal","location":"--internal--"},"devportal.default.1":{"kind":"Mapping","location":"devportal.default","parent":"devportal.default","serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: devportal_mapping\nprefix: /docs/\nservice: devportal\n"},"httpbin.default.1":{"kind":"Mapping","location":"httpbin.default","parent":"httpbin.default","serialization":"apiVersion: ambassador/v1\nhost_rewrite: httpbin.org\nkind: Mapping\nname: httpbin_mapping\nprefix: /httpbin/\nservice: httpbin.org:80\n"},"openapi.default.1":{"kind":"Mapping","location":"openapi.default","parent":"openapi.default","serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: openapi_mapping\nprefix: /openapi/\nservice: openapi\n"},"qotm.default.1":{"kind":"Mapping","location":"qotm.default","parent":"qotm.default","serialization":"apiVersion: ambassador/v1\nhost: qotm.example.com\nkind: Mapping\nname: qotm_mapping\nprefix: /qotm/\nservice: qotm\n"}},"ambassador_resources":{},"ambassador_services":[],"cluster_info":{"cluster_127_0_0_1_8877":{"_active":true,"_errored":false,"_hcolor":"green","_health":"100% healthy","_hmetric":100,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"],"weight":100.0},"cluster_devportal":{"_active":true,"_errored":false,"_hcolor":"green","_health":"100% healthy","_hmetric":100,"_referenced_by":["devportal.default.1"],"_rkey":"cluster_devportal","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"devportal.default.1","name":"cluster_devportal","service":"devportal","type":"strict_dns","urls":["tcp://devportal:80"],"weight":100.0},"cluster_httpbin_org_80":{"_active":true,"_errored":false,"_hcolor":"yellow","_health":"89% healthy","_hmetric":89,"_referenced_by":["httpbin.default.1"],"_rkey":"cluster_httpbin_org_80","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"host_rewrite":"httpbin.org","kind":"IRCluster","lb_type":"round_robin","location":"httpbin.default.1","name":"cluster_httpbin_org_80","service":"httpbin.org:80","type":"strict_dns","urls":["tcp://httpbin.org:80"],"weight":100.0},"cluster_openapi":{"_active":true,"_errored":false,"_hcolor":"green","_health":"100% healthy","_hmetric":100,"_referenced_by":["openapi.default.1"],"_rkey":"cluster_openapi","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"openapi.default.1","name":"cluster_openapi","service":"openapi","type":"strict_dns","urls":["tcp://openapi:80"],"weight":100.0},"cluster_qotm":{"_active":true,"_errored":false,"_hcolor":"grey","_health":"no requests yet","_hmetric":"waiting","_referenced_by":["qotm.default.1"],"_rkey":"cluster_qotm","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"qotm.default.1","name":"cluster_qotm","service":"qotm","type":"strict_dns","urls":["tcp://qotm:80"],"weight":100.0}},"cluster_stats":{"cluster_127_0_0_1_8877":{"hcolor":"green","health":"100% healthy","healthy_members":1,"healthy_percent":100,"hmetric":100,"reason":"Cluster cluster_127_0_0_1_8877 updated at 1554827909","total_members":1,"update_attempts":11120,"update_percent":100,"update_successes":11120,"upstream_4xx":0,"upstream_5xx":0,"upstream_bad":0,"upstream_ok":4,"valid":true},"cluster_devportal":{"hcolor":"green","health":"100% healthy","healthy_members":1,"healthy_percent":100,"hmetric":100,"reason":"Cluster cluster_devportal updated at 1554827909","total_members":1,"update_attempts":9327,"update_percent":100,"update_successes":9327,"upstream_4xx":2445,"upstream_5xx":0,"upstream_bad":0,"upstream_ok":2,"valid":true},"cluster_httpbin_org_80":{"hcolor":"yellow","health":"89% healthy","healthy_members":2,"healthy_percent":89,"hmetric":89,"reason":"Cluster cluster_httpbin_org_80 updated at 1554827909","total_members":2,"update_attempts":11093,"update_percent":100,"update_successes":11093,"upstream_4xx":2743,"upstream_5xx":4,"upstream_bad":4,"upstream_ok":33,"valid":true},"cluster_openapi":{"hcolor":"green","health":"100% healthy","healthy_members":1,"healthy_percent":100,"hmetric":100,"reason":"Cluster cluster_openapi updated at 1554827909","total_members":1,"update_attempts":1342,"update_percent":100,"update_successes":1342,"upstream_4xx":0,"upstream_5xx":0,"upstream_bad":0,"upstream_ok":456,"valid":true},"cluster_qotm":{"hcolor":"grey","health":"no requests yet","healthy_members":1,"healthy_percent":null,"hmetric":"waiting","reason":"Cluster cluster_qotm updated at 1554827909","total_members":1,"update_attempts":11103,"update_percent":100,"update_successes":11103,"upstream_4xx":0,"upstream_5xx":0,"upstream_bad":0,"upstream_ok":0,"valid":true}},"clusters":{"cluster_127_0_0_1_8877":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"]},"cluster_devportal":{"_active":true,"_errored":false,"_referenced_by":["devportal.default.1"],"_rkey":"cluster_devportal","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"devportal.default.1","name":"cluster_devportal","service":"devportal","type":"strict_dns","urls":["tcp://devportal:80"]},"cluster_httpbin_org_80":{"_active":true,"_errored":false,"_referenced_by":["httpbin.default.1"],"_rkey":"cluster_httpbin_org_80","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"host_rewrite":"httpbin.org","kind":"IRCluster","lb_type":"round_robin","location":"httpbin.default.1","name":"cluster_httpbin_org_80","service":"httpbin.org:80","type":"strict_dns","urls":["tcp://httpbin.org:80"]},"cluster_openapi":{"_active":true,"_errored":false,"_referenced_by":["openapi.default.1"],"_rkey":"cluster_openapi","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"openapi.default.1","name":"cluster_openapi","service":"openapi","type":"strict_dns","urls":["tcp://openapi:80"]},"cluster_qotm":{"_active":true,"_errored":false,"_referenced_by":["qotm.default.1"],"_rkey":"cluster_qotm","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"qotm.default.1","name":"cluster_qotm","service":"qotm","type":"strict_dns","urls":["tcp://qotm:80"]}},"envoy_elements":{"--internal--":{"admin":[{"access_log_path":"/tmp/admin_access_log","address":{"socket_address":{"address":"127.0.0.1","port_value":8001}}}],"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_127_0_0_1_8877","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"127.0.0.1","port_value":8877,"protocol":"TCP"}}}}]}]},"name":"cluster_127_0_0_1_8877","type":"STRICT_DNS"}],"listener":[{"address":{"socket_address":{"address":"0.0.0.0","port_value":80,"protocol":"TCP"}},"filter_chains":[{"filters":[{"config":{"access_log":[{"config":{"format":"ACCESS [%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \"%REQ(X-FORWARDED-FOR)%\" \"%REQ(USER-AGENT)%\" \"%REQ(X-REQUEST-ID)%\" \"%REQ(:AUTHORITY)%\" \"%UPSTREAM_HOST%\"\n","path":"/dev/fd/1"},"name":"envoy.file_access_log"}],"http_filters":[{"name":"envoy.cors"},{"name":"envoy.router"}],"normalize_path":true,"route_config":{"virtual_hosts":[{"domains":["*"],"name":"backend","routes":[{"match":{"case_sensitive":true,"prefix":"/ambassador/v0/check_ready"},"route":{"prefix_rewrite":"/ambassador/v0/check_ready","priority":null,"timeout":"10.000s","weighted_clusters":{"clusters":[{"name":"cluster_127_0_0_1_8877","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/ambassador/v0/check_alive"},"route":{"prefix_rewrite":"/ambassador/v0/check_alive","priority":null,"timeout":"10.000s","weighted_clusters":{"clusters":[{"name":"cluster_127_0_0_1_8877","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/ambassador/v0/"},"route":{"prefix_rewrite":"/ambassador/v0/","priority":null,"timeout":"10.000s","weighted_clusters":{"clusters":[{"name":"cluster_127_0_0_1_8877","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/openapi/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_openapi","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/httpbin/"},"route":{"host_rewrite":"httpbin.org","prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_httpbin_org_80","weight":100.0}]}}},{"match":{"case_sensitive":true,"headers":[{"exact_match":"qotm.example.com","name":":authority"}],"prefix":"/qotm/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_qotm","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/docs/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_devportal","weight":100.0}]}}}]}]},"stat_prefix":"ingress_http","use_remote_address":true,"xff_num_trusted_hops":0},"name":"envoy.http_connection_manager"}],"use_proxy_proto":false}],"name":"ambassador-listener-80"}],"route":[{"match":{"case_sensitive":true,"prefix":"/ambassador/v0/"},"route":{"prefix_rewrite":"/ambassador/v0/","priority":null,"timeout":"10.000s","weighted_clusters":{"clusters":[{"name":"cluster_127_0_0_1_8877","weight":100.0}]}}}]},"cluster_127_0_0_1_8877":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_127_0_0_1_8877","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"127.0.0.1","port_value":8877,"protocol":"TCP"}}}}]}]},"name":"cluster_127_0_0_1_8877","type":"STRICT_DNS"}]},"cluster_devportal":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_devportal","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"devportal","port_value":80,"protocol":"TCP"}}}}]}]},"name":"cluster_devportal","type":"STRICT_DNS"}]},"cluster_httpbin_org_80":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_httpbin_org_80","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"httpbin.org","port_value":80,"protocol":"TCP"}}}}]}]},"name":"cluster_httpbin_org_80","type":"STRICT_DNS"}]},"cluster_openapi":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_openapi","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"openapi","port_value":80,"protocol":"TCP"}}}}]}]},"name":"cluster_openapi","type":"STRICT_DNS"}]},"cluster_qotm":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_qotm","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"qotm","port_value":80,"protocol":"TCP"}}}}]}]},"name":"cluster_qotm","type":"STRICT_DNS"}]},"devportal.default.1":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_devportal","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"devportal","port_value":80,"protocol":"TCP"}}}}]}]},"name":"cluster_devportal","type":"STRICT_DNS"}],"route":[{"match":{"case_sensitive":true,"prefix":"/docs/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_devportal","weight":100.0}]}}}]},"httpbin.default.1":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_httpbin_org_80","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"httpbin.org","port_value":80,"protocol":"TCP"}}}}]}]},"name":"cluster_httpbin_org_80","type":"STRICT_DNS"}],"route":[{"match":{"case_sensitive":true,"prefix":"/httpbin/"},"route":{"host_rewrite":"httpbin.org","prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_httpbin_org_80","weight":100.0}]}}}]},"ir.ambassador":{"admin":[{"access_log_path":"/tmp/admin_access_log","address":{"socket_address":{"address":"127.0.0.1","port_value":8001}}}],"route":[{"match":{"case_sensitive":true,"prefix":"/ambassador/v0/"},"route":{"prefix_rewrite":"/ambassador/v0/","priority":null,"timeout":"10.000s","weighted_clusters":{"clusters":[{"name":"cluster_127_0_0_1_8877","weight":100.0}]}}}]},"ir.listener":{"listener":[{"address":{"socket_address":{"address":"0.0.0.0","port_value":80,"protocol":"TCP"}},"filter_chains":[{"filters":[{"config":{"access_log":[{"config":{"format":"ACCESS [%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \"%REQ(X-FORWARDED-FOR)%\" \"%REQ(USER-AGENT)%\" \"%REQ(X-REQUEST-ID)%\" \"%REQ(:AUTHORITY)%\" \"%UPSTREAM_HOST%\"\n","path":"/dev/fd/1"},"name":"envoy.file_access_log"}],"http_filters":[{"name":"envoy.cors"},{"name":"envoy.router"}],"normalize_path":true,"route_config":{"virtual_hosts":[{"domains":["*"],"name":"backend","routes":[{"match":{"case_sensitive":true,"prefix":"/ambassador/v0/check_ready"},"route":{"prefix_rewrite":"/ambassador/v0/check_ready","priority":null,"timeout":"10.000s","weighted_clusters":{"clusters":[{"name":"cluster_127_0_0_1_8877","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/ambassador/v0/check_alive"},"route":{"prefix_rewrite":"/ambassador/v0/check_alive","priority":null,"timeout":"10.000s","weighted_clusters":{"clusters":[{"name":"cluster_127_0_0_1_8877","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/ambassador/v0/"},"route":{"prefix_rewrite":"/ambassador/v0/","priority":null,"timeout":"10.000s","weighted_clusters":{"clusters":[{"name":"cluster_127_0_0_1_8877","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/openapi/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_openapi","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/httpbin/"},"route":{"host_rewrite":"httpbin.org","prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_httpbin_org_80","weight":100.0}]}}},{"match":{"case_sensitive":true,"headers":[{"exact_match":"qotm.example.com","name":":authority"}],"prefix":"/qotm/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_qotm","weight":100.0}]}}},{"match":{"case_sensitive":true,"prefix":"/docs/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_devportal","weight":100.0}]}}}]}]},"stat_prefix":"ingress_http","use_remote_address":true,"xff_num_trusted_hops":0},"name":"envoy.http_connection_manager"}],"use_proxy_proto":false}],"name":"ambassador-listener-80"}]},"openapi.default.1":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_openapi","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"openapi","port_value":80,"protocol":"TCP"}}}}]}]},"name":"cluster_openapi","type":"STRICT_DNS"}],"route":[{"match":{"case_sensitive":true,"prefix":"/openapi/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_openapi","weight":100.0}]}}}]},"qotm.default.1":{"cluster":[{"connect_timeout":"3s","dns_lookup_family":"V4_ONLY","lb_policy":"ROUND_ROBIN","load_assignment":{"cluster_name":"cluster_qotm","endpoints":[{"lb_endpoints":[{"endpoint":{"address":{"socket_address":{"address":"qotm","port_value":80,"protocol":"TCP"}}}}]}]},"name":"cluster_qotm","type":"STRICT_DNS"}],"route":[{"match":{"case_sensitive":true,"headers":[{"exact_match":"qotm.example.com","name":":authority"}],"prefix":"/qotm/"},"route":{"prefix_rewrite":"/","priority":null,"timeout":"3.000s","weighted_clusters":{"clusters":[{"name":"cluster_qotm","weight":100.0}]}}}]}},"envoy_resources":{},"envoy_status":{"alive":true,"ready":true,"since_update":"3 seconds ago","uptime":"1 day, 2 hours, 28 minutes, 19 seconds"},"errors":[],"groups":{"grp-2b4b73af30246d0aa72db2add7782f41b6b9cd6e":{"_active":true,"_errored":false,"_referenced_by":["openapi.default.1"],"_rkey":"openapi.default.1","group_id":"2b4b73af30246d0aa72db2add7782f41b6b9cd6e","group_weight":[0,9,0,"/openapi/","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"openapi.default.1","mappings":[{"_active":true,"_errored":false,"_rkey":"openapi.default.1","cluster":{"_active":true,"_errored":false,"_referenced_by":["openapi.default.1"],"_rkey":"cluster_openapi","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"openapi.default.1","name":"cluster_openapi","service":"openapi","type":"strict_dns","urls":["tcp://openapi:80"]},"group_id":"2b4b73af30246d0aa72db2add7782f41b6b9cd6e","headers":[],"kind":"Mapping","location":"openapi.default.1","name":"openapi_mapping","precedence":0,"prefix":"/openapi/","rewrite":"/","route_weight":[0,9,0,"/openapi/","GET"],"serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: openapi_mapping\nprefix: /openapi/\nservice: openapi\n","service":"openapi","weight":100.0}],"name":"GROUP: openapi_mapping","precedence":0,"prefix":"/openapi/","rewrite":"/","serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: openapi_mapping\nprefix: /openapi/\nservice: openapi\n"},"grp-40fccb26412e8c52387d223fde6ae3bf2d321716":{"_active":true,"_errored":false,"_referenced_by":["qotm.default.1"],"_rkey":"qotm.default.1","group_id":"40fccb26412e8c52387d223fde6ae3bf2d321716","group_weight":[0,6,26,"/qotm/","GET",":authority-qotm.example.com"],"headers":[{"name":":authority","regex":false,"value":"qotm.example.com"}],"kind":"IRHTTPMappingGroup","location":"qotm.default.1","mappings":[{"_active":true,"_errored":false,"_rkey":"qotm.default.1","cluster":{"_active":true,"_errored":false,"_referenced_by":["qotm.default.1"],"_rkey":"cluster_qotm","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"qotm.default.1","name":"cluster_qotm","service":"qotm","type":"strict_dns","urls":["tcp://qotm:80"]},"group_id":"40fccb26412e8c52387d223fde6ae3bf2d321716","headers":[{"name":":authority","regex":false,"value":"qotm.example.com"}],"host":"qotm.example.com","kind":"Mapping","location":"qotm.default.1","name":"qotm_mapping","precedence":0,"prefix":"/qotm/","rewrite":"/","route_weight":[0,6,26,"/qotm/","GET",":authority-qotm.example.com"],"serialization":"apiVersion: ambassador/v1\nhost: qotm.example.com\nkind: Mapping\nname: qotm_mapping\nprefix: /qotm/\nservice: qotm\n","service":"qotm","weight":100.0}],"name":"GROUP: qotm_mapping","precedence":0,"prefix":"/qotm/","rewrite":"/","serialization":"apiVersion: ambassador/v1\nhost: qotm.example.com\nkind: Mapping\nname: qotm_mapping\nprefix: /qotm/\nservice: qotm\n"},"grp-7df546235997704c909d473af2cbcb5e606d20de":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","group_id":"7df546235997704c909d473af2cbcb5e606d20de","group_weight":[0,26,0,"/ambassador/v0/check_alive","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"--internal--","mappings":[{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","cluster":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"]},"group_id":"7df546235997704c909d473af2cbcb5e606d20de","headers":[],"kind":"IRMapping","location":"--internal--","name":"internal_liveness_probe_mapping","precedence":0,"prefix":"/ambassador/v0/check_alive","rewrite":"/ambassador/v0/check_alive","route_weight":[0,26,0,"/ambassador/v0/check_alive","GET"],"service":"127.0.0.1:8877","timeout_ms":10000,"weight":100.0}],"name":"GROUP: internal_liveness_probe_mapping","precedence":0,"prefix":"/ambassador/v0/check_alive","rewrite":"/ambassador/v0/check_alive","timeout_ms":10000},"grp-8de18501d2044fe30db225289b318d5fda913b64":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","group_id":"8de18501d2044fe30db225289b318d5fda913b64","group_weight":[0,15,0,"/ambassador/v0/","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"--internal--","mappings":[{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","cluster":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"]},"group_id":"8de18501d2044fe30db225289b318d5fda913b64","headers":[],"kind":"IRMapping","location":"--internal--","name":"internal_diagnostics_probe_mapping","precedence":0,"prefix":"/ambassador/v0/","rewrite":"/ambassador/v0/","route_weight":[0,15,0,"/ambassador/v0/","GET"],"service":"127.0.0.1:8877","timeout_ms":10000,"weight":100.0}],"name":"GROUP: internal_diagnostics_probe_mapping","precedence":0,"prefix":"/ambassador/v0/","rewrite":"/ambassador/v0/","timeout_ms":10000},"grp-98f512b6b64c77c8ea7026dbd725bba703cfaee2":{"_active":true,"_errored":false,"_referenced_by":["devportal.default.1"],"_rkey":"devportal.default.1","group_id":"98f512b6b64c77c8ea7026dbd725bba703cfaee2","group_weight":[0,6,0,"/docs/","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"devportal.default.1","mappings":[{"_active":true,"_errored":false,"_rkey":"devportal.default.1","cluster":{"_active":true,"_errored":false,"_referenced_by":["devportal.default.1"],"_rkey":"cluster_devportal","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"devportal.default.1","name":"cluster_devportal","service":"devportal","type":"strict_dns","urls":["tcp://devportal:80"]},"group_id":"98f512b6b64c77c8ea7026dbd725bba703cfaee2","headers":[],"kind":"Mapping","location":"devportal.default.1","name":"devportal_mapping","precedence":0,"prefix":"/docs/","rewrite":"/","route_weight":[0,6,0,"/docs/","GET"],"serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: devportal_mapping\nprefix: /docs/\nservice: devportal\n","service":"devportal","weight":100.0}],"name":"GROUP: devportal_mapping","precedence":0,"prefix":"/docs/","rewrite":"/","serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: devportal_mapping\nprefix: /docs/\nservice: devportal\n"},"grp-b4db12f5b638f1750062dd4220911c4f6f44fc57":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","group_id":"b4db12f5b638f1750062dd4220911c4f6f44fc57","group_weight":[0,26,0,"/ambassador/v0/check_ready","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"--internal--","mappings":[{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","cluster":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"]},"group_id":"b4db12f5b638f1750062dd4220911c4f6f44fc57","headers":[],"kind":"IRMapping","location":"--internal--","name":"internal_readiness_probe_mapping","precedence":0,"prefix":"/ambassador/v0/check_ready","rewrite":"/ambassador/v0/check_ready","route_weight":[0,26,0,"/ambassador/v0/check_ready","GET"],"service":"127.0.0.1:8877","timeout_ms":10000,"weight":100.0}],"name":"GROUP: internal_readiness_probe_mapping","precedence":0,"prefix":"/ambassador/v0/check_ready","rewrite":"/ambassador/v0/check_ready","timeout_ms":10000},"grp-c4ada926d9d7864b666698db04169283442dce24":{"_active":true,"_errored":false,"_referenced_by":["httpbin.default.1"],"_rkey":"httpbin.default.1","group_id":"c4ada926d9d7864b666698db04169283442dce24","group_weight":[0,9,0,"/httpbin/","GET"],"headers":[],"host_rewrite":"httpbin.org","kind":"IRHTTPMappingGroup","location":"httpbin.default.1","mappings":[{"_active":true,"_errored":false,"_rkey":"httpbin.default.1","cluster":{"_active":true,"_errored":false,"_referenced_by":["httpbin.default.1"],"_rkey":"cluster_httpbin_org_80","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"host_rewrite":"httpbin.org","kind":"IRCluster","lb_type":"round_robin","location":"httpbin.default.1","name":"cluster_httpbin_org_80","service":"httpbin.org:80","type":"strict_dns","urls":["tcp://httpbin.org:80"]},"group_id":"c4ada926d9d7864b666698db04169283442dce24","headers":[],"host_rewrite":"httpbin.org","kind":"Mapping","location":"httpbin.default.1","name":"httpbin_mapping","precedence":0,"prefix":"/httpbin/","rewrite":"/","route_weight":[0,9,0,"/httpbin/","GET"],"serialization":"apiVersion: ambassador/v1\nhost_rewrite: httpbin.org\nkind: Mapping\nname: httpbin_mapping\nprefix: /httpbin/\nservice: httpbin.org:80\n","service":"httpbin.org:80","weight":100.0}],"name":"GROUP: httpbin_mapping","precedence":0,"prefix":"/httpbin/","rewrite":"/","serialization":"apiVersion: ambassador/v1\nhost_rewrite: httpbin.org\nkind: Mapping\nname: httpbin_mapping\nprefix: /httpbin/\nservice: httpbin.org:80\n"}},"loginfo":{"all":"info"},"notices":[{"level":"DEBUG","message":"Returning cached result"},{"level":"NOTICE","message":"-global-: Ambassador 0.60 will default to listening on port 8080 for HTTP. You will need to change your configuration to continue using port 80."}],"route_info":[{"_group_id":"b4db12f5b638f1750062dd4220911c4f6f44fc57","_route":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","group_id":"b4db12f5b638f1750062dd4220911c4f6f44fc57","group_weight":[0,26,0,"/ambassador/v0/check_ready","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"--internal--","mappings":[{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","cluster":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"]},"group_id":"b4db12f5b638f1750062dd4220911c4f6f44fc57","headers":[],"kind":"IRMapping","location":"--internal--","name":"internal_readiness_probe_mapping","precedence":0,"prefix":"/ambassador/v0/check_ready","rewrite":"/ambassador/v0/check_ready","route_weight":[0,26,0,"/ambassador/v0/check_ready","GET"],"service":"127.0.0.1:8877","timeout_ms":10000,"weight":100.0}],"name":"GROUP: internal_readiness_probe_mapping","precedence":0,"prefix":"/ambassador/v0/check_ready","rewrite":"/ambassador/v0/check_ready","timeout_ms":10000},"_source":"--internal--","clusters":[{"_active":true,"_errored":false,"_hcolor":"green","_health":"100% healthy","_hmetric":100,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"],"weight":100.0}],"headers":[],"host":"*","key":"http://192.168.39.80:31320/ambassador/v0/check_ready","method":"*","prefix":"/ambassador/v0/check_ready","rewrite":"/ambassador/v0/check_ready"},{"_group_id":"7df546235997704c909d473af2cbcb5e606d20de","_route":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","group_id":"7df546235997704c909d473af2cbcb5e606d20de","group_weight":[0,26,0,"/ambassador/v0/check_alive","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"--internal--","mappings":[{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","cluster":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"]},"group_id":"7df546235997704c909d473af2cbcb5e606d20de","headers":[],"kind":"IRMapping","location":"--internal--","name":"internal_liveness_probe_mapping","precedence":0,"prefix":"/ambassador/v0/check_alive","rewrite":"/ambassador/v0/check_alive","route_weight":[0,26,0,"/ambassador/v0/check_alive","GET"],"service":"127.0.0.1:8877","timeout_ms":10000,"weight":100.0}],"name":"GROUP: internal_liveness_probe_mapping","precedence":0,"prefix":"/ambassador/v0/check_alive","rewrite":"/ambassador/v0/check_alive","timeout_ms":10000},"_source":"--internal--","clusters":[{"_active":true,"_errored":false,"_hcolor":"green","_health":"100% healthy","_hmetric":100,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"],"weight":100.0}],"headers":[],"host":"*","key":"http://192.168.39.80:31320/ambassador/v0/check_alive","method":"*","prefix":"/ambassador/v0/check_alive","rewrite":"/ambassador/v0/check_alive"},{"_group_id":"8de18501d2044fe30db225289b318d5fda913b64","_route":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","group_id":"8de18501d2044fe30db225289b318d5fda913b64","group_weight":[0,15,0,"/ambassador/v0/","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"--internal--","mappings":[{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"ir.ambassador","cluster":{"_active":true,"_errored":false,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"]},"group_id":"8de18501d2044fe30db225289b318d5fda913b64","headers":[],"kind":"IRMapping","location":"--internal--","name":"internal_diagnostics_probe_mapping","precedence":0,"prefix":"/ambassador/v0/","rewrite":"/ambassador/v0/","route_weight":[0,15,0,"/ambassador/v0/","GET"],"service":"127.0.0.1:8877","timeout_ms":10000,"weight":100.0}],"name":"GROUP: internal_diagnostics_probe_mapping","precedence":0,"prefix":"/ambassador/v0/","rewrite":"/ambassador/v0/","timeout_ms":10000},"_source":"--internal--","clusters":[{"_active":true,"_errored":false,"_hcolor":"green","_health":"100% healthy","_hmetric":100,"_referenced_by":["--internal--"],"_rkey":"cluster_127_0_0_1_8877","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"--internal--","name":"cluster_127_0_0_1_8877","service":"127.0.0.1:8877","type":"strict_dns","urls":["tcp://127.0.0.1:8877"],"weight":100.0}],"headers":[],"host":"*","key":"http://192.168.39.80:31320/ambassador/v0/","method":"*","prefix":"/ambassador/v0/","rewrite":"/ambassador/v0/"},{"_group_id":"2b4b73af30246d0aa72db2add7782f41b6b9cd6e","_route":{"_active":true,"_errored":false,"_referenced_by":["openapi.default.1"],"_rkey":"openapi.default.1","group_id":"2b4b73af30246d0aa72db2add7782f41b6b9cd6e","group_weight":[0,9,0,"/openapi/","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"openapi.default.1","mappings":[{"_active":true,"_errored":false,"_rkey":"openapi.default.1","cluster":{"_active":true,"_errored":false,"_referenced_by":["openapi.default.1"],"_rkey":"cluster_openapi","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"openapi.default.1","name":"cluster_openapi","service":"openapi","type":"strict_dns","urls":["tcp://openapi:80"]},"group_id":"2b4b73af30246d0aa72db2add7782f41b6b9cd6e","headers":[],"kind":"Mapping","location":"openapi.default.1","name":"openapi_mapping","precedence":0,"prefix":"/openapi/","rewrite":"/","route_weight":[0,9,0,"/openapi/","GET"],"serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: openapi_mapping\nprefix: /openapi/\nservice: openapi\n","service":"openapi","weight":100.0}],"name":"GROUP: openapi_mapping","precedence":0,"prefix":"/openapi/","rewrite":"/","serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: openapi_mapping\nprefix: /openapi/\nservice: openapi\n"},"_source":"openapi.default.1","clusters":[{"_active":true,"_errored":false,"_hcolor":"green","_health":"100% healthy","_hmetric":100,"_referenced_by":["openapi.default.1"],"_rkey":"cluster_openapi","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"openapi.default.1","name":"cluster_openapi","service":"openapi","type":"strict_dns","urls":["tcp://openapi:80"],"weight":100.0}],"headers":[],"host":"*","key":"http://192.168.39.80:31320/openapi/","method":"*","prefix":"/openapi/","rewrite":"/"},{"_group_id":"c4ada926d9d7864b666698db04169283442dce24","_route":{"_active":true,"_errored":false,"_referenced_by":["httpbin.default.1"],"_rkey":"httpbin.default.1","group_id":"c4ada926d9d7864b666698db04169283442dce24","group_weight":[0,9,0,"/httpbin/","GET"],"headers":[],"host_rewrite":"httpbin.org","kind":"IRHTTPMappingGroup","location":"httpbin.default.1","mappings":[{"_active":true,"_errored":false,"_rkey":"httpbin.default.1","cluster":{"_active":true,"_errored":false,"_referenced_by":["httpbin.default.1"],"_rkey":"cluster_httpbin_org_80","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"host_rewrite":"httpbin.org","kind":"IRCluster","lb_type":"round_robin","location":"httpbin.default.1","name":"cluster_httpbin_org_80","service":"httpbin.org:80","type":"strict_dns","urls":["tcp://httpbin.org:80"]},"group_id":"c4ada926d9d7864b666698db04169283442dce24","headers":[],"host_rewrite":"httpbin.org","kind":"Mapping","location":"httpbin.default.1","name":"httpbin_mapping","precedence":0,"prefix":"/httpbin/","rewrite":"/","route_weight":[0,9,0,"/httpbin/","GET"],"serialization":"apiVersion: ambassador/v1\nhost_rewrite: httpbin.org\nkind: Mapping\nname: httpbin_mapping\nprefix: /httpbin/\nservice: httpbin.org:80\n","service":"httpbin.org:80","weight":100.0}],"name":"GROUP: httpbin_mapping","precedence":0,"prefix":"/httpbin/","rewrite":"/","serialization":"apiVersion: ambassador/v1\nhost_rewrite: httpbin.org\nkind: Mapping\nname: httpbin_mapping\nprefix: /httpbin/\nservice: httpbin.org:80\n"},"_source":"httpbin.default.1","clusters":[{"_active":true,"_errored":false,"_hcolor":"yellow","_health":"89% healthy","_hmetric":89,"_referenced_by":["httpbin.default.1"],"_rkey":"cluster_httpbin_org_80","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"host_rewrite":"httpbin.org","kind":"IRCluster","lb_type":"round_robin","location":"httpbin.default.1","name":"cluster_httpbin_org_80","service":"httpbin.org:80","type":"strict_dns","urls":["tcp://httpbin.org:80"],"weight":100.0}],"headers":[],"host":"*","key":"http://192.168.39.80:31320/httpbin/","method":"*","prefix":"/httpbin/","rewrite":"/"},{"_group_id":"40fccb26412e8c52387d223fde6ae3bf2d321716","_route":{"_active":true,"_errored":false,"_referenced_by":["qotm.default.1"],"_rkey":"qotm.default.1","group_id":"40fccb26412e8c52387d223fde6ae3bf2d321716","group_weight":[0,6,26,"/qotm/","GET",":authority-qotm.example.com"],"headers":[{"name":":authority","regex":false,"value":"qotm.example.com"}],"kind":"IRHTTPMappingGroup","location":"qotm.default.1","mappings":[{"_active":true,"_errored":false,"_rkey":"qotm.default.1","cluster":{"_active":true,"_errored":false,"_referenced_by":["qotm.default.1"],"_rkey":"cluster_qotm","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"qotm.default.1","name":"cluster_qotm","service":"qotm","type":"strict_dns","urls":["tcp://qotm:80"]},"group_id":"40fccb26412e8c52387d223fde6ae3bf2d321716","headers":[{"name":":authority","regex":false,"value":"qotm.example.com"}],"host":"qotm.example.com","kind":"Mapping","location":"qotm.default.1","name":"qotm_mapping","precedence":0,"prefix":"/qotm/","rewrite":"/","route_weight":[0,6,26,"/qotm/","GET",":authority-qotm.example.com"],"serialization":"apiVersion: ambassador/v1\nhost: qotm.example.com\nkind: Mapping\nname: qotm_mapping\nprefix: /qotm/\nservice: qotm\n","service":"qotm","weight":100.0}],"name":"GROUP: qotm_mapping","precedence":0,"prefix":"/qotm/","rewrite":"/","serialization":"apiVersion: ambassador/v1\nhost: qotm.example.com\nkind: Mapping\nname: qotm_mapping\nprefix: /qotm/\nservice: qotm\n"},"_source":"qotm.default.1","clusters":[{"_active":true,"_errored":false,"_hcolor":"grey","_health":"no requests yet","_hmetric":"waiting","_referenced_by":["qotm.default.1"],"_rkey":"cluster_qotm","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"qotm.default.1","name":"cluster_qotm","service":"qotm","type":"strict_dns","urls":["tcp://qotm:80"],"weight":100.0}],"headers":[],"host":"qotm.example.com","key":"http://qotm.example.com/qotm/","method":"*","prefix":"/qotm/","rewrite":"/"},{"_group_id":"98f512b6b64c77c8ea7026dbd725bba703cfaee2","_route":{"_active":true,"_errored":false,"_referenced_by":["devportal.default.1"],"_rkey":"devportal.default.1","group_id":"98f512b6b64c77c8ea7026dbd725bba703cfaee2","group_weight":[0,6,0,"/docs/","GET"],"headers":[],"kind":"IRHTTPMappingGroup","location":"devportal.default.1","mappings":[{"_active":true,"_errored":false,"_rkey":"devportal.default.1","cluster":{"_active":true,"_errored":false,"_referenced_by":["devportal.default.1"],"_rkey":"cluster_devportal","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"devportal.default.1","name":"cluster_devportal","service":"devportal","type":"strict_dns","urls":["tcp://devportal:80"]},"group_id":"98f512b6b64c77c8ea7026dbd725bba703cfaee2","headers":[],"kind":"Mapping","location":"devportal.default.1","name":"devportal_mapping","precedence":0,"prefix":"/docs/","rewrite":"/","route_weight":[0,6,0,"/docs/","GET"],"serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: devportal_mapping\nprefix: /docs/\nservice: devportal\n","service":"devportal","weight":100.0}],"name":"GROUP: devportal_mapping","precedence":0,"prefix":"/docs/","rewrite":"/","serialization":"apiVersion: ambassador/v1\nkind: Mapping\nname: devportal_mapping\nprefix: /docs/\nservice: devportal\n"},"_source":"devportal.default.1","clusters":[{"_active":true,"_errored":false,"_hcolor":"green","_health":"100% healthy","_hmetric":100,"_referenced_by":["devportal.default.1"],"_rkey":"cluster_devportal","enable_endpoints":false,"enable_ipv4":true,"enable_ipv6":false,"endpoint":{},"kind":"IRCluster","lb_type":"round_robin","location":"devportal.default.1","name":"cluster_devportal","service":"devportal","type":"strict_dns","urls":["tcp://devportal:80"],"weight":100.0}],"headers":[],"host":"*","key":"http://192.168.39.80:31320/docs/","method":"*","prefix":"/docs/","rewrite":"/"}],"source_map":{"--diagnostics--":{"--diagnostics--":true},"--internal--":{"--internal--":true},"devportal.default":{"devportal.default.1":true},"devportal.default.1":{"devportal.default.1":true},"httpbin.default":{"httpbin.default.1":true},"httpbin.default.1":{"httpbin.default.1":true},"openapi.default":{"openapi.default.1":true},"openapi.default.1":{"openapi.default.1":true},"qotm.default":{"qotm.default.1":true},"qotm.default.1":{"qotm.default.1":true}},"system":{"boot_time":"Mon, 08 Apr 2019 14:10:13 GMT","cluster_id":"49d72073-4b06-57f2-84bb-55a068ffa206","hostname":"ambassador-648955975b-kp6xr","hr_uptime":"1 day, 2 hours, 28 minutes, 19 seconds","version":"0.53.1"}}`), nil
	}
	if url == "http://ambassador/openapi/.ambassador-internal/openapi-docs" {
		if internalSecret == "" {
			return nil, errors.New(".ambassador-internal URLs should get secret")
		}
		return []byte(` {
        "openapi": "3.0.0",
        "info": {
            "title": "My API",
            "description": "description",
            "version": 1.0
        },
        "servers": [
            {
                "url": "http://api.example.com/"
            }
        ],
        "paths": {
            "/widgets": {
                "get": {
                    "summary": "Get widgets.",
                    "responses": {
                        "200": {
                            "description": "A JSON array of widgets",
                            "content": {
                                "application/json": {
                                    "schema": {
                                        "type": "array",
                                        "items": {
                                            "type": "string"
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
`), nil
	}
	return nil, fmt.Errorf("Unknown URL")
}

// Big picture test of retrieving info from diagd and OpenAPI endpoint.
func TestFetcherRetrieve(t *testing.T) {
	g := NewGomegaWithT(t)
	s := NewServer()

	// Start out knowing about one service, but it's going to go away:
	oldSvc := Service{Name: "old"}
	s.getServiceAdd()(oldSvc, "http://whatev", "/foo", nil)
	g.Expect(s.knownServices()).To(Equal([]Service{oldSvc}))

	file, _ := ioutil.TempFile("", "prefix")
	file.WriteString("abc")
	f := NewFetcher(
		s.getServiceAdd(), s.getServiceDelete(), fakeHTTPGet,
		s.knownServices(),
		"http://localhost:8877", "http://ambassador", 1,
		"https://publicapi.com", file.Name())

	// When we retrieve we will be told about a bunch of new services. Only
	// one of them will have OpenAPI docs, though.
	f.retrieve()

	httpbin := Service{Name: "httpbin", Namespace: "default"}
	devportal := Service{Name: "devportal", Namespace: "default"}
	openapi := Service{Name: "openapi", Namespace: "default"}
	qotm := Service{Name: "qotm", Namespace: "default"}

	// old service went away, we detected new ones:
	knownServices := s.knownServices()
	sort.Slice(knownServices, func(i, j int) bool {
		return knownServices[i].Name < knownServices[j].Name
	})
	g.Expect(knownServices).To(Equal([]Service{devportal, httpbin, openapi, qotm}))

	// openapi has OpenAPI doc, others don't:
	g.Expect(s.K8sStore.Get(httpbin, false)).To(Equal(&ServiceMetadata{
		Prefix:  "/httpbin",
		BaseURL: "https://publicapi.com", HasDoc: false, Doc: nil}))
	// This one has custom Host route in the annotation:
	g.Expect(s.K8sStore.Get(qotm, false)).To(Equal(&ServiceMetadata{
		Prefix:  "/qotm",
		BaseURL: "https://qotm.example.com", HasDoc: false, Doc: nil}))
	// This one has an OpenAPI doc:
	json, _ := fakeHTTPGet("http://ambassador/openapi/.ambassador-internal/openapi-docs", f.internalSecret, nil)
	g.Expect(s.K8sStore.Get(openapi, true)).To(Equal(&ServiceMetadata{
		Prefix:  "/openapi",
		BaseURL: "https://publicapi.com", HasDoc: true,
		Doc: NewOpenAPI(json, "https://publicapi.com", "/openapi")}))
}
