# @TEMPLATE@
---
apiVersion: batch/v1
kind: Job
metadata:
  name: preload
  namespace: docker-registry
spec:
  template:
    spec:
      restartPolicy: Never
      volumes:
      - name: docker-socket-volume
        hostPath:
          path: /var/run/docker.sock
          type: File
      containers:
      - name: docker
        image: docker:19.03
        command: ['sh', '-ex', '-c', '
          for image in {{ env "PRELOAD_IMAGES" }}; do
            preload_name="localhost:31000/preload/$(echo "$image"|sed "s/[:/]/_/g")";
            docker pull "$preload_name" || true;
            docker pull "$image";
            docker tag "$image" "$preload_name";
            docker push "$preload_name";
          done
        ']
        securityContext:
          privileged: true
        volumeMounts:
        - mountPath: /var/run/docker.sock
          name: docker-socket-volume
