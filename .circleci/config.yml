version: 2.1

# Secure environement variables set from the Web UI:
# - DEPLOY_KEY_ID (AWS S3)
# - DEPLOY_KEY (AWS S3)
# - DOCKER_TOKEN (Quay)
# - KUBERNAUT_TOKEN (Kubernaut)

commands:
  aws-install:
    steps:
      - run: |
          sudo pip install awscli

  node-install:
    steps:
      - run: |
          echo 'export NVM_DIR=/opt/circleci/.nvm' >> ${BASH_ENV}
          echo 'source $NVM_DIR/nvm.sh' >> ${BASH_ENV}
      - run: |
          nvm alias default 10

  golang-install:
    parameters:
      os:
        type: string
    steps:
      # Golang install

      # For some reason it is faster to curl into a file than to just
      # pipe the curl straight to tar.
      - run: |
          sudo rm -rf /usr/local/go
          curl https://dl.google.com/go/go1.12.<<parameters.os>>-amd64.tar.gz -o /tmp/go.tgz
          sudo tar -C /usr/local -xzf /tmp/go.tgz

      # Golang paths
      - run: |
          echo 'export PATH=${HOME}/go/bin:${PATH}:/usr/local/go/bin' >> ${BASH_ENV}
          echo 'export GOPATH=${HOME}/go' >> ${BASH_ENV}
          echo 'export GOBIN=${HOME}/go/bin' >> ${BASH_ENV}

      - run: mkdir -p ${GOPATH} ${GOBIN}

  kubectl-install:
    steps:
      - run: curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.12.2/bin/$(go env GOOS)/$(go env GOARCH)/kubectl
      - run: chmod a+x ./kubectl
      - run: sudo mv kubectl /usr/local/bin

  save-go-mod-cache:
    steps:
      - run:
          command: |
            mkdir -p "$(go env GOPATH)/pkg/mod/cache/download/"
            rsync -av --delete "$(go env GOPATH)/pkg/mod/cache/download/" ~/goproxy
          when: always
      - save_cache:
          # Use {{arch}} as a proxy for
          # {{.Environment.HOME}}... because despite what the CircleCI
          # docs say, {{.Environment.HOME}} evaluates to "<no value>".
          #
          # Why put it in $HOME, instead of /tmp or something, and be
          # able to share the cache?  Because /tmp is a symlink to
          # /private/tmp on macOS, and CircleCI is broken on macOS
          # whenever symlinks are involved.
          key: go-mod-cache-{{ arch }}-{{ checksum "go.mod" }}-{{ .BuildNum }}
          paths: "~/goproxy"
          when: always
  restore-go-mod-cache:
    steps:
      - restore_cache:
          keys:
            - go-mod-cache-{{ arch }}-{{ checksum "go.mod" }}-
            - go-mod-cache-{{ arch }}-
      - run: |
          GOPROXY=file://$HOME/goproxy make go-get || true

  save-go-build-cache:
    steps:
      - run:
          command: |
            mkdir -p "$(go env GOCACHE)"
            rsync -av --delete "$(go env GOCACHE)/" ~/gobuild
          when: always
      - save_cache:
          key: go-build-cache-{{ arch }}-{{ .BuildNum }}
          paths: "~/gobuild"
          when: always
  restore-go-build-cache:
    steps:
      - restore_cache:
          keys:
            - go-build-cache-{{ arch }}-{{ .BuildNum }}
            - go-build-cache-{{ arch }}-
      - run: |
          mkdir -p "$(go env GOCACHE)"
          rsync -av --delete ~/gobuild/ "$(go env GOCACHE)"

  main:
    steps:
      - checkout
      - restore-go-mod-cache
      - restore-go-build-cache
      - run: make build
      - save-go-mod-cache
      - run: |
          trap 'make unclaim' EXIT
          set -x
          make check
      - save-go-build-cache
      - run:
          name: "gather logs"
          when: always
          command: |
            rsync -ma --include='*/' --include='*.tap' --include='*.log' --include='idp_*.png' --exclude='*' . /tmp/test-logs
      - store_artifacts:
          path: /tmp/test-logs
          destination: test-logs
      # Verify that the build is still not dirty
      - run: make help
  release:
    steps:
      - run: |
          if [[ "$CIRCLE_TAG" =~ ^v[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+(-.*)?$ ]]; then
              export AWS_ACCESS_KEY_ID=$DEPLOY_KEY_ID
              export AWS_SECRET_ACCESS_KEY=$DEPLOY_KEY
              docker login -u="datawire+releasebot" -p="${DOCKER_TOKEN}" quay.io
              make release
          else
              make release RELEASE_DRYRUN=y
          fi
  clobber:
    steps:
      # Run "make clobber", and verify that it cleans everything.  Do
      # this last, and only if everything so far has passed; don't
      # wipe out artifacts that are useful for debugging.
      - run: |
          make clobber
      - run: |
          test -z "$(git clean -ndx)"

jobs:

  macos-build:
    macos:
      xcode: "10.1.0"
    working_directory: ~/repo
    steps:
      - aws-install
      - golang-install:
          os: darwin
      - kubectl-install
      - main

  machine-build:
    machine:
      # If you bump this, be sure to bump the pyenv key in
      # "restore_cache" and "save_cache" below.
      image: "ubuntu-1604:201903-01"
    working_directory: ~/repo
    steps:
      - aws-install
      - golang-install:
          os: linux
      - kubectl-install
      - node-install
      - restore_cache:
          key: "pyenv-201903-01-3.6.3"
      - run:
          name: "Install Python 3.6"
          command: |
            pyenv versions
            pyenv install --skip-existing 3.6.3
            pyenv global 2.7.12 3.6.3
            pyenv versions
      - save_cache:
          key: "pyenv-201903-01-3.6.3"
          paths:
            - "/opt/circleci/.pyenv"
      - main
      - release
      - clobber


workflows:
  version: 2.1

  multibuild:
    jobs:
      - machine-build:
          filters:
            tags:
              only: /.*/
      - macos-build:
          filters:
            branches:
              only: master
