{{- if .Values.enableLegacyVersions }}
---
################################################################################
# ServiceAccount                                                               #
################################################################################
apiVersion: v1
kind: ServiceAccount
metadata:
  name: emissary-apiext
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/instance: emissary-apiext
    app.kubernetes.io/managed-by: helm
    app.kubernetes.io/name: emissary-apiext
    app.kubernetes.io/part-of: emissary-apiext
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    emissary-ingress.dev/control-plane-ns: {{ .Values.emissary.namespace }}
---
################################################################################
# Cluster permissions                                                          #
################################################################################
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: emissary-apiext
  labels:
    app.kubernetes.io/instance: emissary-apiext
    app.kubernetes.io/managed-by: helm
    app.kubernetes.io/name: emissary-apiext
    app.kubernetes.io/part-of: emissary-apiext
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    emissary-ingress.dev/control-plane-ns: {{ .Values.emissary.namespace }}
rules:
  - apiGroups: [ "apiextensions.k8s.io" ]
    resources: [ "customresourcedefinitions" ]
    verbs: [ "list", "watch" ]
  - apiGroups: [ "apiextensions.k8s.io" ]
    resources: [ "customresourcedefinitions", "customresourcedefinitions/status" ]
    resourceNames:
      - authservices.getambassador.io
      - consulresolvers.getambassador.io
      - devportals.getambassador.io
      - hosts.getambassador.io
      - kubernetesendpointresolvers.getambassador.io
      - kubernetesserviceresolvers.getambassador.io
      - listeners.getambassador.io
      - logservices.getambassador.io
      - mappings.getambassador.io
      - modules.getambassador.io
      - ratelimitservices.getambassador.io
      - tcpmappings.getambassador.io
      - tlscontexts.getambassador.io
      - tracingservices.getambassador.io
    verbs: [ "update" ]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: emissary-apiext
  labels:
    app.kubernetes.io/instance: emissary-apiext
    app.kubernetes.io/managed-by: helm
    app.kubernetes.io/name: emissary-apiext
    app.kubernetes.io/part-of: emissary-apiext
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    emissary-ingress.dev/control-plane-ns: {{ .Values.emissary.namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: emissary-apiext
subjects:
  - kind: ServiceAccount
    namespace: {{ .Release.Namespace }}
    name: emissary-apiext
---
################################################################################
# Namespaced permissions                                                       #
################################################################################
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: emissary-apiext
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/instance: emissary-apiext
    app.kubernetes.io/managed-by: helm
    app.kubernetes.io/name: emissary-apiext
    app.kubernetes.io/part-of: emissary-apiext
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    emissary-ingress.dev/control-plane-ns: {{ .Values.emissary.namespace }}
rules:
  - apiGroups: [ "" ]
    resources: [ "secrets" ]
    verbs: [ "create", "list", "watch" ]
  - apiGroups: [ "" ]
    resources: [ "secrets" ]
    resourceNames: [ "emissary-ingress-webhook-ca" ]
    verbs: [ "get", "update" ]
  - apiGroups: [ "coordination.k8s.io" ]
    resources: [ "leases" ]
    verbs: [ "create" ]
  - apiGroups: [ "coordination.k8s.io" ]
    resources: [ "leases" ]
    resourceNames: [ "emissary-ca-mgr-leader" ]
    verbs: [ "get", "update" ]
  - apiGroups: [ "" ]
    resources: [ "events" ]
    verbs: [ "create" ]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: emissary-apiext
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/instance: emissary-apiext
    app.kubernetes.io/managed-by: helm
    app.kubernetes.io/name: emissary-apiext
    app.kubernetes.io/part-of: emissary-apiext
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    emissary-ingress.dev/control-plane-ns: {{ .Values.emissary.namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: emissary-apiext
subjects:
- kind: ServiceAccount
  namespace: {{ .Release.Namespace }}
  name: emissary-apiext
---
################################################################################
# Main                                                                         #
################################################################################
apiVersion: v1
kind: Service
metadata:
  name: emissary-apiext
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/instance: emissary-apiext
    app.kubernetes.io/managed-by: helm
    app.kubernetes.io/name: emissary-apiext
    app.kubernetes.io/part-of: emissary-apiext
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    emissary-ingress.dev/control-plane-ns: {{ .Values.emissary.namespace }}
spec:
  type: ClusterIP
  ports:
    - name: https
      port: 443
      targetPort: https
  selector:
    app.kubernetes.io/instance: emissary-apiext
    app.kubernetes.io/name: emissary-apiext
    app.kubernetes.io/part-of: emissary-apiext
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emissary-apiext
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/instance: emissary-apiext
    app.kubernetes.io/managed-by: helm
    app.kubernetes.io/name: emissary-apiext
    app.kubernetes.io/part-of: emissary-apiext
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    emissary-ingress.dev/control-plane-ns: {{ .Values.emissary.namespace }}
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: emissary-apiext
      app.kubernetes.io/name: emissary-apiext
      app.kubernetes.io/part-of: emissary-apiext
  replicas: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: emissary-apiext
        app.kubernetes.io/managed-by: helm
        app.kubernetes.io/name: emissary-apiext
        app.kubernetes.io/part-of: emissary-apiext
        helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
        emissary-ingress.dev/control-plane-ns: {{ .Values.emissary.namespace }}
    spec:
      serviceAccountName: emissary-apiext
      containers:
        - name: emissary-apiext
          image: {{ .Values.apiext.repository }}:{{ .Values.apiext.tag }}
          imagePullPolicy: {{ .Values.apiext.pullPolicy }}
          command: [ "apiext", "emissary-apiext" ]
          args: [ "--crd-label-selector", "app.kubernetes.io/part-of=emissary-apiext" ]
          ports:
            - name: http
              containerPort: 8080
            - name: https
              containerPort: 8443
          startupProbe:
            httpGet:
              path: /probes/live
              port: 8080
            failureThreshold: 10
            periodSeconds: 3
          livenessProbe:
            httpGet:
              scheme: HTTP
              path: /probes/live
              port: 8080
            periodSeconds: 3
            failureThreshold: 3
          readinessProbe:
            httpGet:
              scheme: HTTP
              path: /probes/ready
              port: 8080
            periodSeconds: 3
            failureThreshold: 3
{{- end -}}
