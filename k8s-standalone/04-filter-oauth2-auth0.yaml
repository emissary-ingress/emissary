# @TEMPLATE@
---
apiVersion: getambassador.io/v1beta2
kind: Filter
metadata:
  name: auth0
  namespace: standalone
spec:
  OAuth2:
    authorizationURL: {{env "IDP_AUTH0_PROVIDER_URL"}}
    clientURL: {{env "AUTH_TENANT_URL"}}
    audience: {{env "IDP_AUTH0_AUDIENCE"}}
    clientID: {{env "IDP_AUTH0_CLIENT_ID"}}
    secret: {{env "IDP_AUTH0_CLIENT_SECRET"}}
    maxStale: 12h
---
apiVersion: getambassador.io/v1beta2
kind: Filter
metadata:
  name: auth0-jwt
  namespace: standalone
spec:
  JWT:
    # These settings are taken from "{{env "IDP_AUTH0_PROVIDER_URL"}}/.well-known/openid-configuration"
    jwksURI: "https://ambassador-oauth-e2e.auth0.com/.well-known/jwks.json"
    issuer: "https://ambassador-oauth-e2e.auth0.com/"
    # Add "none", for testing purposes
    validAlgorithms:
    - "RS256"
    - "RS384"
    - "RS512"
    - "none"
---
apiVersion: getambassador.io/v1beta2
kind: Filter
metadata:
  name: auth0-k8s
  namespace: standalone
spec:
  OAuth2:
    authorizationURL: {{env "IDP_AUTH0_PROVIDER_URL"}}
    clientURL: {{env "AUTH_TENANT_URL"}}
    audience: {{env "IDP_AUTH0_AUDIENCE"}}
    clientID: {{env "IDP_AUTH0_CLIENT_ID"}}
    secretName: auth0-secret
    maxStale: 12h
---
apiVersion: getambassador.io/v1beta2
kind: Filter
metadata:
  name: wiki-plugin
  namespace: standalone
spec:
  # set ambassador_id as a test of https://github.com/datawire/apro/issues/227
  ambassador_id: "default"
  Plugin:
    name: wiki-plugin
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: filter-oauth2-auth0-mapping-1
  namespace: standalone
spec:
  prefix: /httpbin/
  service: httpbin.org:80
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: filter-oauth2-auth0-mapping-2
  namespace: standalone
spec:
  prefix: /auth0/httpbin/
  rewrite: /
  service: httpbin.org:80
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: filter-oauth2-auth0-mapping-3
  namespace: standalone
spec:
  prefix: /auth0-k8s/httpbin/
  rewrite: /
  service: httpbin.org:80
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v1
kind: Mapping
metadata:
  name: filter-oauth2-auth0-mapping-4
  namespace: standalone
spec:
  prefix: /auth0-or-jwt/
  rewrite: /
  service: httpbin.org:80
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v1beta2
kind: FilterPolicy
metadata:
  name: filter-oauth2-auth0-policy
  namespace: standalone
spec:
  rules:
    # /httpbin/
    - host: "*"
      path: /httpbin/ip
      filters: null
    - host: "*"
      path: /httpbin/**
      filters:
        - name: auth0
        - name: wiki-plugin
    # /auth0/httpbin/
    - host: "*"
      path: /auth0/httpbin/**
      filters:
        - name: auth0
          arguments:
            insteadOfRedirect:         # optional, default is to do a redirect
              ifRequestHeader:         # optional, default is to return httpStatusCode for all requests that would redirect-to-IDP
                name: X-Requested-With # required
    # /auth0-k8s/httpbin/
    - host: "*"
      path: /auth0-k8s/httpbin/**
      filters:
        - name: auth0-k8s
          arguments:
            insteadOfRedirect:         # optional, default is to do a redirect
              httpStatusCode: 401      # optional, default is 403
              ifRequestHeader:         # optional, default is to return httpStatusCode for all requests that would redirect-to-IDP
                name: X-Requested-With # required
                value: XMLHttpRequest  # optional, default is any non-empty string
    - host: "*"
      path: /auth0-or-jwt/**
      filters:
        - name: auth0
          arguments:
            insteadOfRedirect:         # optional, default is to do a redirect
              ifRequestHeader:         # optional, default is to return httpStatusCode for all requests that would redirect-to-IDP
                name: X-Requested-With # required
              filters:
              - name: auth0-jwt
                arguments:
                  scope:
                  - openid
