#!/usr/bin/env bash

cd "${BASH_SOURCE[0]%.tap.gen}" &&
./node_modules/.bin/mocha ./main.js --timeout 10000 --reporter tap 2>&1 |
	# Do this in Bash instead of 'sed' so that it doesn't buffer stdout.
	while IFS= read -r line; do
		case "$line" in
			'1..'*|'ok '*) printf '%s\n' "$line";;
			'not ok '*)
				line="${line#not }"
				line="${line%%#*}"
				line="${line} # SKIP: these are flakey"
				printf '%s\n' "$line"
				;;
			*) printf '#%s\n' "$line";; # mocha outputs invalid lines
		esac
	done
