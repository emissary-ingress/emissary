# Start with a very conservative configuration, and slowly turn things
# back on.
linters:
  disable-all: true
  enable: # please keep this list sorted
    - depguard
    - errcheck
    - gofmt
    - goimports
    - govet
    - importas
    - unused
linters-settings: # please keep this list sorted
  depguard:
    list-type: blacklist
    include-go-root: true
    packages-with-error-message:
      - log:                            "Use `github.com/datawire/dlib/dlog` instead of `log`"
      - github.com/sirupsen/logrus:     "Use `github.com/datawire/dlib/dlog` instead of `github.com/sirupsen/logrus`"
      - github.com/datawire/dlib/dutil: "Use either `github.com/datawire/dlib/derror` or `github.com/datawire/dlib/dhttp` instead of `github.com/datawire/dlib/dutil`"
      - github.com/gogo/protobuf:       "Use `google.golang.org/protobuf` instead of `github.com/gogo/protobuf`"
      - github.com/golang/protobuf:     "Use `google.golang.org/protobuf` instead of `github.com/golang/protobuf`"
      - github.com/google/shlex:        "Use `github.com/kballard/go-shellquote` instead of `github.com/google/shlex`"
      - golang.org/x/net/http2/h2c:     "Use `github.com/datawire/dlib/dhttp` instead of `golang.org/x/net/http2/h2c`"
  errcheck:
    exclude-functions:
      - "(net/http.ResponseWriter).Write"
  gofmt:
    simplify: true
  goimports:
    # TODO: replace 'goimports' with 'gci', which lets us be more
    # prescriptive.  The blocker switching to gci that is that a while
    # back it broke support for having multiple named prefixes in the
    # same section together.
    local-prefixes: github.com/emissary-ingress,github.com/datawire
  importas:
    no-unaliased: true
    alias:
      ######################################################################
      # Envoy API                                                          #
      ######################################################################
      # special cases
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/api/envoy/type
        alias: apiv2_type
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/api/envoy/extensions/filters/network/http_connection_manager/(?P<version>.*)
        alias: api${version}_httpman
      # ex: apiv2_route "github.com/emissary-ingress/emissary/v3/pkg/api/envoy/api/v2/route"
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/api/envoy/api/(?P<version>v[0-9][^/]*)/(?P<name>.*)
        alias: api${version}_${name}
      # ex: apiv3_svc_cluster "github.com/emissary-ingress/emissary/v3/pkg/api/envoy/service/cluster/v3"
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/api/envoy/service/(?P<name>[^/]+)/(?P<version>v[0-9][^/]*)
        alias: api${version}_svc_${name}
      # ex: apiv3_cluster "github.com/emissary-ingress/emissary/v3/pkg/api/envoy/config/cluster/v3"
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/api/envoy/([^se].*/)?(?P<name>[^/]+)/(?P<version>v[0-9][^/]*)
        alias: api${version}_${name}
      ######################################################################
      # Envoy-control-plane                                                #
      ######################################################################
      # 1 word without version
      # ex: ecp_wellknown "github.com/emissary-ingress/emissary/v3/pkg/envoy-control-plane/wellknown"
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/envoy-control-plane/(?P<name>[^/]+)
        alias: ecp_${name}
      # 2 words without version
      # ex: ecp_cache_types "github.com/emissary-ingress/emissary/v3/pkg/envoy-control-plane/cache/types"
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/envoy-control-plane/(?P<name1>[^/]+)/(?P<name2>[^v][^/]*)
        alias: ecp_${name1}_${name2}
      # 1 word with version
      # ex: ecp_v3_cache "github.com/emissary-ingress/emissary/v3/pkg/envoy-control-plane/cache/v3"
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/envoy-control-plane/(?P<name>[^/]+)/(?P<version>v[0-9][^/]*)
        alias: ecp_${version}_${name}
      # 2 words with version
      # ex: ecp_v3_server_stream "github.com/emissary-ingress/emissary/v3/pkg/envoy-control-plane/server/stream/v3"
      - pkg: github.com/emissary-ingress/emissary/v3/pkg/envoy-control-plane/(?P<name1>[^/]+)/(?P<name2>[^/]+)/(?P<version>v[0-9][^/]*)
        alias: ecp_${version}_${name1}_${name2}
  unused:
    # treat code as a program (not a library) and report unused
    # exported identifiers
    check-exported: true
issues:
  exclude-rules:
    - linters:
        - errcheck
        - govet
        - importas
        - unused
      path: pkg/envoy-control-plane/
    - linters: [depguard]
      path: "pkg/envoy-control-plane/(test/|.*_test\\.go)"
    - linters: [depguard]
      path: "pkg/envoy-control-plane/"
      source: '"github\.com/golang/protobuf'
    - linters: [govet]
      text: "^tests: .* should return nothing$"
run:
  timeout: 9m # CircleCI is slow?

# I don't know of a linter that lets you blacklist specific functions
# and variables within a package, but if one exists, I would like to
# blacklist all of the following for the reason "Don't use globals!":
#
# - net/http.DefaultServeMux
#   * net/http.Handle()
#   * net/http.HandleFunc()
# - flag.CommandLine
#   * flag.VisitAll()
#   * flag.Visit()
#   * flag.Lookup()
#   * flag.Set()
#   * flag.PrintDefaults()
#   * flag.Usage()
#   * flag.NFlag()
#   * flag.Arg()
#   * flag.NArg()
#   * flag.Args()
#   * flag.BoolVar()
#   * flag.Bool()
#   * flag.IntVar()
#   * flag.Int()
#   * flag.Int64Var()
#   * flag.Int64()
#   * flag.UintVar()
#   * flag.Uint()
#   * flag.Uint64Var()
#   * flag.Uint64()
#   * flag.StringVar()
#   * flag.String()
#   * flag.Float64Var()
#   * flag.Float64()
#   * flag.DurationVar()
#   * flag.Duration()
#   * flag.Var()
#   * flag.Parse()
#   * flag.Parsed()
#
# I'd also like to blacklist parts of net/http to enforce using dhttp:
#
# - net/http.Server // use dhttp.ServerConfig instead!
#   * net/http.Serve()
#   * net/http.ServeTLS()
#   * net/http.ListenAndServe()
#   * net/http.ListenAndServeTLS()
# - google.golang.org/grpc.Server.Serve // use dhttp.ServerConfig{Handler: grpcServer}.Serve instead!

# The old configuration, that hasn't been used for many months:

#linters:
#  enable-all: true
#  disable:
#    - errcheck
#    - gochecknoglobals
#    - gochecknoinits
#    - golint
#    - interfacer # author says it's deprecated, gives very subjective advice
#    - lll
#    - maligned
#    - prealloc
#    - scopelint
#    - stylecheck
#    - unparam
#linters-settings:
#  goimports:
#    # put imports beginning with prefix after 3rd-party packages;
#    # it's a comma-separated list of prefixes
#    local-prefixes: github.com/datawire/apro,github.com/lyft/ratelimit
#  depguard:
#    list-type: blacklist
#    include-go-root: true
#    packages:
#      - errors                              # use "github.com/pkg/errors"
#      - golang.org/x/net/context            # use "context"
#      - github.com/datawire/teleproxy       # use "github.com/datawire/ambassador/pkg"
#      - github.com/datawire/ambassador/go   # use "github.com/datawire/ambassador/pkg"
#      - github.com/datawire/kat-backend/xds # use "github.com/datawire/ambassador/pkg/api/envoy"
#      - github.com/lyft/ratelimit/proto     # use "github.com/datawire/ambassador/pkg/api/envoy"
#      #- github.com/russross/blackfriday     # use "github.com/russross/blackfriday/v2" # can't turn off prefix-matching
#      - gopkg.in/russross/blackfriday.v2    # use "github.com/russross/blackfriday/v2"
#  goconst:
#    min-len: 12
#issues:
#  new-from-rev: a72c53cbcd05c806b1838d95146d049b09a51ffb
#run:
#  build-tags:
#    - test
#    - integration
#    - lint
