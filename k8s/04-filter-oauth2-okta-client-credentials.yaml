# @TEMPLATE@
# See also: 04-filter-pauth2-okta.yaml

# This comes directly from https://dev-264701-admin.okta.com/admin/app/oidc_client/instance/0oaeshpr0wKNbyWQn356/#tab-general
# The administrator credentials to view that page are at
#    $(keybase config get -b mountdir)/team/datawireio/secrets/okta.dev-264701.firstname_lastname.*
{{ $Okta_Org_URL := "https://dev-264701.okta.com" }}
# Make sure that:
#  - A "myScope" custom scope is added
#  - You added a client of the appropriate type (and configure it in ./tests/cluster/go-test/filter-oauth2/oauth2_test.go)

---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: okta-client-credentials
spec:
  OAuth2:
    authorizationURL: {{ $Okta_Org_URL }}/oauth2/default
    grantType: ClientCredentials
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: filter-oauth2-okta-client-credentialsmapping
spec:
  prefix: /okta-client-credentials/httpbin/
  rewrite: /
  service: httpbin.default.svc.cluster.local
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: FilterPolicy
metadata:
  name: filter-oauth2-okta-client-credentials-policy
spec:
  rules:
    - host: "*"
      path: /okta-client-credentials/httpbin/**
      filters:
      - name: okta-client-credentials
        arguments:
          scopes:
          - "myScope"
