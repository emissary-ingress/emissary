# @TEMPLATE@
# See also: 03-auth0-secret.yaml

{{ $AmbassadorURL := "https://ambassador.ambassador.svc.cluster.local" }}
# These come directly from https://manage.auth0.com/#/applications/DOzF9q7U2OrvB7QniW9ikczS1onJgyiC/settings
# The administrator credentials to see that page are at
#    $(keybase config get -b mountdir)/team/datawireio/secrets/auth0.auth0.apro-testing.*
{{ $Auth0_Domain := "ambassador-oauth-e2e.auth0.com" }}
{{ $Auth0_Client_ID := "DOzF9q7U2OrvB7QniW9ikczS1onJgyiC" }}
{{ $Auth0_Client_Secret := "MkpnAmzX-EEzV708qD_giNd9CF_R-owNau94QZVgOfna9FYf-SdTvATuNkrEDBk-" }}
# Make sure that:
#  - "{{$AmbassadorURL}}/callback" is in the "Allowed Callback URLs" textbox
#  - "{{$AmbassadorURL}}" is in the "Allowed Web Origins" textbox
#  - A test user account is set up (and configured in ./tests/cluster/go-test/filter-oauth2/testdata/idp_auth0.js)

---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: auth0
spec:
  OAuth2:
    authorizationURL: https://{{ $Auth0_Domain }}
    clientURL: {{ $AmbassadorURL }}
    audience: https://{{ $Auth0_Domain }}/api/v2/
    clientID: {{ $Auth0_Client_ID }}
    secret: {{ $Auth0_Client_Secret }}
    maxStale: 12h
---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: auth0-k8s
spec:
  OAuth2:
    authorizationURL: https://{{ $Auth0_Domain }}
    clientURL: {{ $AmbassadorURL }}
    audience: https://{{ $Auth0_Domain }}/api/v2/
    clientID: {{ $Auth0_Client_ID }}
    secretName: auth0-secret
    maxStale: 12h
---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: wiki-plugin
spec:
  # set ambassador_id as a test of https://github.com/datawire/apro/issues/227
  ambassador_id: "default"
  Plugin:
    name: wiki-plugin
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: filter-oauth2-auth0-mapping-1
spec:
  prefix: /httpbin/
  service: httpbin.org:80
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: filter-oauth2-auth0-mapping-2
spec:
  prefix: /auth0/httpbin/
  rewrite: /
  service: httpbin.org:80
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: filter-oauth2-auth0-mapping-3
spec:
  prefix: /auth0-k8s/httpbin/
  rewrite: /
  service: httpbin.org:80
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: FilterPolicy
metadata:
  name: filter-oauth2-auth0-policy
spec:
  rules:
    # /httpbin/
    - host: "*"
      path: /httpbin/ip
      filters: null
    - host: "*"
      path: /httpbin/**
      filters:
        - name: auth0
        #- name: wiki-plugin
    # /auth0/httpbin/
    - host: "*"
      path: /auth0/httpbin/**
      filters:
        - name: auth0
          arguments:
            insteadOfRedirect:         # optional, default is to do a redirect
              ifRequestHeader:         # optional, default is to return httpStatusCode for all requests that would redirect-to-IDP
                name: X-Requested-With # required
    # /auth0-k8s/httpbin/
    - host: "*"
      path: /auth0-k8s/httpbin/**
      filters:
        - name: auth0-k8s
          arguments:
            insteadOfRedirect:         # optional, default is to do a redirect
              httpStatusCode: 401      # optional, default is 403
              ifRequestHeader:         # optional, default is to return httpStatusCode for all requests that would redirect-to-IDP
                name: X-Requested-With # required
                value: XMLHttpRequest  # optional, default is any non-empty string
