# @TEMPLATE@

{{ $AmbassadorURL := "https://ambassador.ambassador.svc.cluster.local" }}
# These come directly from https://manage.auth0.com/#/applications/DOzF9q7U2OrvB7QniW9ikczS1onJgyiC/settings
# The administrator credentials to see that page are at
#    $(keybase config get -b mountdir)/team/datawireio/secrets/auth0.auth0.apro-testing.*
{{ $Auth0_Domain := "ambassador-oauth-e2e.auth0.com" }}
{{ $Auth0_Client_ID := "DOzF9q7U2OrvB7QniW9ikczS1onJgyiC" }}
{{ $Auth0_Client_Secret := "MkpnAmzX-EEzV708qD_giNd9CF_R-owNau94QZVgOfna9FYf-SdTvATuNkrEDBk-" }}
# Make sure that:
#  - "{{$AmbassadorURL}}/.ambassador/oauth2/redirection-endpoint" is in the "Allowed Callback URLs" textbox
#  - "{{$AmbassadorURL}}" is in the "Allowed Web Origins" textbox
#  - A test user account is set up (and configured in ./tests/cluster/go-test/filter-oauth2/testdata/idp_auth0.js)

# Case 1: /oauth2-auth0-nojwt-and-plugin-and-whitelist/
#  1. Simple Auth0 configuration--we don't set the 'audience'
#     Authorization Parameter, so the Access Token is _not_ a JWT, so
#     we thereby test falling back to `accessTokenValidation:
#     userinfo`.
#  2. We chain it with the wiki-plugin, thereby testing
#     a. FilterPolicies combining multiple filters
#     b. the ability to run Plugins
#  3. The `/ip` endpoint is excluded from authentication, testing that
#     we can punch holes.
---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: oauth2-auth0-nojwt
spec:
  OAuth2:
    authorizationURL: https://{{ $Auth0_Domain }}
    clientURL: {{ $AmbassadorURL }}
    clientID: {{ $Auth0_Client_ID }}
    secret: {{ $Auth0_Client_Secret }}
    maxStale: 12h
---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: wiki-plugin
spec:
  # set ambassador_id as a test of https://github.com/datawire/apro/issues/227
  ambassador_id: "default"
  Plugin:
    name: wiki-plugin
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: oauth2-auth0-nojwt-and-plugin-and-whitelist
spec:
  prefix: /oauth2-auth0-nojwt-and-plugin-and-whitelist/
  rewrite: /
  service: httpbin.default.svc.cluster.local
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: FilterPolicy
metadata:
  name: oauth2-auth0-nojwt-and-plugin-and-whitelist
spec:
  rules:
    - host: "*"
      path: /oauth2-auth0-nojwt-and-plugin-and-whitelist/ip
      filters: null
    - host: "*"
      path: /oauth2-auth0-nojwt-and-plugin-and-whitelist/**
      filters:
        - name: oauth2-auth0-nojwt
        - name: wiki-plugin

# Case 2: /oauth2-auth0-nojwt-and-k8ssecret-and-xhrerror/
#  1. Similar Auth0 configuration to Case 1 (/oauth2-auth0-nojwt-â€¦), but load
#     the client secret from a Kubernetes Secret, instead of having it
#     inline.
#  2. We test exact-matching with insteadOfRedirect error-responses.
---
apiVersion: v1
metadata:
  name: auth0-secret
kind: Secret
data:
  oauth2-client-secret: {{ b64enc $Auth0_Client_Secret }}
---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: oauth2-auth0-nojwt-and-k8ssecret
spec:
  OAuth2:
    authorizationURL: https://{{ $Auth0_Domain }}
    clientURL: {{ $AmbassadorURL }}
    clientID: {{ $Auth0_Client_ID }}
    secretName: auth0-secret
    maxStale: 12h
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: oauth2-auth0-nojwt-and-k8ssecret-and-xhrerror
spec:
  prefix: /oauth2-auth0-nojwt-and-k8ssecret-and-xhrerror/
  rewrite: /
  service: httpbin.default.svc.cluster.local
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: FilterPolicy
metadata:
  name: oauth2-auth0-nojwt-and-k8ssecret-and-xhrerror
spec:
  rules:
    - host: "*"
      path: /oauth2-auth0-nojwt-and-k8ssecret-and-xhrerror/**
      filters:
        - name: oauth2-auth0-nojwt-and-k8ssecret
          arguments:
            insteadOfRedirect:
              httpStatusCode: 401
              ifRequestHeader:
                name: X-Requested-With
                value: XMLHttpRequest

# Case 3: /oauth2-auth0-nojwt-and-anyerror/
#  1. We test any-matching with insteadOfRedirect error-responses.
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: oauth2-auth0-nojwt-and-anyerror
spec:
  prefix: /oauth2-auth0-nojwt-and-anyerror/
  rewrite: /
  service: httpbin.default.svc.cluster.local
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: FilterPolicy
metadata:
  name: oauth2-auth0-nojwt-and-anyerror
spec:
  rules:
    - host: "*"
      path: /oauth2-auth0-nojwt-and-anyerror/**
      filters:
        - name: oauth2-auth0-nojwt
          arguments:
            insteadOfRedirect:
              ifRequestHeader:
                name: X-Requested-With

# Case 4: /oauth2-auth0-simplejwt/
#  1. Set the (non-standard) "audience" Authorization Parameter, so
#     that the Access Token is a JWT, and we can test JWT validation.
---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: oauth2-auth0-simplejwt
spec:
  OAuth2:
    authorizationURL: https://{{ $Auth0_Domain }}
    clientURL: {{ $AmbassadorURL }}
    clientID: {{ $Auth0_Client_ID }}
    secret: {{ $Auth0_Client_Secret }}
    maxStale: 12h
    extraAuthorizationParameters:
      audience: "urn:datawire:ambassador:testapi"
    accessTokenValidation: jwt
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: oauth2-auth0-simplejwt
spec:
  prefix: /oauth2-auth0-simplejwt/
  rewrite: /
  service: httpbin.default.svc.cluster.local
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: FilterPolicy
metadata:
  name: oauth2-auth0-simplejwt
spec:
  rules:
    - host: "*"
      path: /oauth2-auth0-simplejwt/**
      filters:
        - name: oauth2-auth0-simplejwt

# Case 5: /oauth2-auth0-complexjwt/
#  1. Set the (non-standard) "audience" Authorization Parameter, so
#     that the Access Token is a JWT, and we can test JWT validation.
#  2. Set `accessTokenJWTFilter` to do more configurable validation
#     (validate that the "aud" claim is set).
#  3. Use the JWT Filter directly if the "Authorization" header is
#     set.
---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: oauth2-auth0-complexjwt
spec:
  OAuth2:
    authorizationURL: https://{{ $Auth0_Domain }}
    clientURL: {{ $AmbassadorURL }}
    clientID: {{ $Auth0_Client_ID }}
    secret: {{ $Auth0_Client_Secret }}
    maxStale: 12h
    extraAuthorizationParameters:
      audience: "urn:datawire:ambassador:testapi"
    accessTokenValidation: jwt
    accessTokenJWTFilter:
      name: jwt-auth0
      arguments:
        scope:
        - openid
---
apiVersion: getambassador.io/v2
kind: Filter
metadata:
  name: jwt-auth0
spec:
  JWT:
    # These settings are taken from "https://{{ $Auth0_Domain }}/.well-known/openid-configuration"
    jwksURI: "https://ambassador-oauth-e2e.auth0.com/.well-known/jwks.json"
    issuer: "https://ambassador-oauth-e2e.auth0.com/"
    # This is our "complex" validation
    audience: "urn:datawire:ambassador:testapi"
    requireAudience: true
    injectRequestHeaders:
    - name: "X-Test-Header"
      value: "yeppers"
    # Add "none" for testing purposes, so that we can craft our own JWTs
    validAlgorithms:
    - "RS256"
    - "none"
---
apiVersion: getambassador.io/v2
kind: Mapping
metadata:
  name: oauth2-auth0-complexjwt
spec:
  prefix: /oauth2-auth0-complexjwt/
  rewrite: /
  service: httpbin.default.svc.cluster.local
  host_rewrite: httpbin.org
  timeout_ms: 5000
---
apiVersion: getambassador.io/v2
kind: FilterPolicy
metadata:
  name: oauth2-auth0-complexjwt
spec:
  rules:
    - host: "*"
      path: /oauth2-auth0-complexjwt/**
      filters:
        - name: oauth2-auth0-complexjwt
          arguments:
            insteadOfRedirect:
              ifRequestHeader:
                name: X-Requested-With
              filters:
              - name: jwt-auth0
                arguments:
                  scope:
                  - openid
